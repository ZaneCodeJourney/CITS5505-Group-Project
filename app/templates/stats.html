{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    .stats-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 20px;
        margin-bottom: 30px;
    }

    .stats-card {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        flex: 1;
        min-width: 200px;
        text-align: center;
        transition: transform 0.3s ease;
    }

    .stats-card:hover {
        transform: translateY(-5px);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #4a89dc;
        display: block;
        margin: 10px 0;
    }

    .stat-label {
        font-size: 1rem;
        color: #666;
    }
    
    .section-header {
        margin: 40px 0 20px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #4a89dc;
        color: #333;
        font-size: 1.5rem;
    }

    .charts-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .chart-card {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
    }

    .chart-title {
        margin-bottom: 15px;
        font-size: 1.2rem;
        color: #333;
    }

    #diveMapContainer {
        height: 500px;
        width: 100%;
        margin-bottom: 30px;
    }

    .map-card {
        grid-column: span 2;
    }
    
    /* New styles for map section layout */
    .map-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        grid-column: 1 / -1;
    }
    
    /* New styles for species section */
    .species-section {
        display: grid;
        grid-template-columns: 1fr 1.5fr;
        gap: 20px;
        grid-column: 1 / -1;
    }
    
    .species-chart-container {
        max-width: 100%;
        height: 400px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    #speciesChart {
        max-width: 100%;
        max-height: 360px;
    }
    
    .species-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .species-table th, .species-table td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .species-table th {
        background-color: #f5f5f5;
    }
    
    .species-table img {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
    }
    
    .species-table .species-name {
        font-weight: 500;
        color: #333;
    }
    
    .species-table .species-scientific {
        font-style: italic;
        font-size: 0.9rem;
        color: #666;
    }
    
    .species-table .species-count {
        font-weight: 500;
        color: #4a89dc;
    }
    
    @media (max-width: 992px) {
        .map-section, .species-section {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1>My Diving Statistics Dashboard</h1>

    <br>
    
    <div class="stats-container">
        <div class="stats-card">
            <span class="stat-label">Total Dives</span>
            <span class="stat-value">{{ stats.total_dives }}</span>
        </div>
        <div class="stats-card">
            <span class="stat-label">Max Depth</span>
            <span class="stat-value">{{ stats.max_depth|round(1) }}m</span>
        </div>
        <div class="stats-card">
            <span class="stat-label">Longest Dive</span>
            <span class="stat-value">{{ stats.longest_dive }} min</span>
        </div>
        <div class="stats-card">
            <span class="stat-label">Total Dive Time</span>
            <span class="stat-value">{{ stats.total_dive_time }} hours</span>
        </div>
    </div>
    
    <!-- Section 1: Dive Locations -->
    <h2 class="section-header">Where You've Dived</h2>
    <div class="charts-container">
        <div class="map-section">
            <div class="chart-card">
                <h3 class="chart-title">Your Dive Locations Heatmap</h3>
                <div id="diveMapContainer"></div>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title">Dives by Location</h3>
                <canvas id="locationChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Section 2: Dive Patterns and Metrics -->
    <h2 class="section-header">Your Diving Patterns</h2>
    <div class="charts-container">
        <div class="chart-card">
            <h3 class="chart-title">Dive Depths Over Time</h3>
            <canvas id="depthChart"></canvas>
        </div>
        <div class="chart-card">
            <h3 class="chart-title">Dive Duration Over Time</h3>
            <canvas id="durationChart"></canvas>
        </div>
        <div class="chart-card">
            <h3 class="chart-title">Monthly Dive Activity</h3>
            <canvas id="monthlyChart"></canvas>
        </div>
    </div>
    
    <!-- Section 3: Species Observations -->
    <h2 class="section-header">Marine Life Encountered</h2>
    <div class="charts-container">
        <div class="species-section">
            <div class="chart-card">
                <h3 class="chart-title">Species You've Observed</h3>
                <canvas id="speciesChart"></canvas>
            </div>
            
            <div class="chart-card">
                <h3 class="chart-title">Top Species Encountered</h3>
                {% if dive_data.top_species and dive_data.top_species|length > 0 %}
                <table class="species-table">
                    <thead>
                        <tr>
                            <th>Species</th>
                            <th>Image</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for species in dive_data.top_species %}
                        <tr>
                            <td>
                                <div class="species-name">{{ species.common_name }}</div>
                                <div class="species-scientific">{{ species.scientific_name }}</div>
                            </td>
                            <td>
                                {% if species.image_url %}
                                <img src="{{ species.image_url }}" alt="{{ species.common_name }}">
                                {% else %}
                                <div style="width: 60px; height: 60px; background-color: #f5f5f5; border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                                    <span style="color: #999;">No image</span>
                                </div>
                                {% endif %}
                            </td>
                            <td class="species-count">{{ species.count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="text-align: center; color: #666; padding: 30px 0;">
                    No species data available. Add species to your dive logs to see statistics.
                </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Chart data from backend
        const diveData = {{ dive_data|tojson }};
        
        // Initialize the map
        const map = L.map('diveMapContainer').setView([20, 0], 2);
        
        // Add the tile layer (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Add heat map layer if we have coordinates
        if (diveData.coordinates && diveData.coordinates.length > 0) {
            // Format data for heatmap: [lat, lng, intensity]
            const heatPoints = diveData.coordinates.map((coord, index) => {
                // Increase base intensity and use dive count as a multiplier
                const intensity = diveData.dives_count && diveData.dives_count[index] ? diveData.dives_count[index] * 3 : 3;
                return [coord[0], coord[1], intensity];
            });
            
            // Create and add the heatmap layer with much larger spots for demo
            L.heatLayer(heatPoints, {
                radius: 30,  // Much larger radius
                blur: 30,    // More blur for softer edges
                maxZoom: 10,
                minOpacity: 0.6,  // Ensure spots are visible even with few points
                max: 10,  // Lower max value to make spots appear more intense
                gradient: {0.4: 'blue', 0.6: 'lime', 0.8: 'yellow', 1: 'red'}
            }).addTo(map);
            
            // If we have points, fit the map to show all points
            if (diveData.coordinates.length > 0) {
                const bounds = L.latLngBounds(diveData.coordinates);
                map.fitBounds(bounds, { padding: [100, 100] });  // More padding
            }
        } else {
            // Display a message if no coordinates are available
            const noDataDiv = document.createElement('div');
            noDataDiv.innerHTML = 'No dive locations with GPS coordinates available. Add latitude and longitude to your dive logs to see them on the map.';
            noDataDiv.style.textAlign = 'center';
            noDataDiv.style.padding = '20px';
            noDataDiv.style.color = '#666';
            document.getElementById('diveMapContainer').appendChild(noDataDiv);
        }
        
        // NEW: Species Pie Chart
        if (diveData.species_names && diveData.species_names.length > 0) {
            const speciesCtx = document.getElementById('speciesChart').getContext('2d');
            new Chart(speciesCtx, {
                type: 'pie',
                data: {
                    labels: diveData.species_names,
                    datasets: [{
                        data: diveData.species_counts,
                        backgroundColor: [
                            '#4a89dc', '#50c878', '#ff6b6b', '#ffd166', 
                            '#8a2be2', '#20b2aa', '#ff7f50', '#6a5acd',
                            '#9370db', '#3cb371', '#f08080', '#ffa07a',
                            '#66cdaa', '#9932cc', '#e9967a', '#8fbc8f'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            const speciesCanvas = document.getElementById('speciesChart');
            if (speciesCanvas) {
                const ctx = speciesCanvas.getContext('2d');
                ctx.font = '14px Arial';
                ctx.fillStyle = '#666';
                ctx.textAlign = 'center';
                ctx.fillText('No species data available', speciesCanvas.width / 2, speciesCanvas.height / 2);
            }
        }
        
        // Depth Chart
        const depthCtx = document.getElementById('depthChart').getContext('2d');
        new Chart(depthCtx, {
            type: 'line',
            data: {
                labels: diveData.dates,
                datasets: [{
                    label: 'Depth (meters)',
                    data: diveData.depths,
                    borderColor: '#4a89dc',
                    backgroundColor: 'rgba(74, 137, 220, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        reverse: true,
                        title: {
                            display: true,
                            text: 'Depth (m)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                }
            }
        });
        
        // Duration Chart
        const durationCtx = document.getElementById('durationChart').getContext('2d');
        new Chart(durationCtx, {
            type: 'line',
            data: {
                labels: diveData.dates,
                datasets: [{
                    label: 'Duration (minutes)',
                    data: diveData.durations,
                    borderColor: '#50c878',
                    backgroundColor: 'rgba(80, 200, 120, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Duration (min)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date'
                        }
                    }
                }
            }
        });
        
        // Location Chart
        const locationCtx = document.getElementById('locationChart').getContext('2d');
        new Chart(locationCtx, {
            type: 'doughnut',
            data: {
                labels: diveData.locations,
                datasets: [{
                    data: diveData.dives_per_location,
                    backgroundColor: [
                        '#4a89dc', '#50c878', '#ff6b6b', '#ffd166', 
                        '#8a2be2', '#20b2aa', '#ff7f50', '#6a5acd'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                    }
                }
            }
        });
        
        // Monthly Chart
        const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
        new Chart(monthlyCtx, {
            type: 'bar',
            data: {
                labels: diveData.months,
                datasets: [{
                    label: 'Number of Dives',
                    data: diveData.dives_per_month,
                    backgroundColor: 'rgba(74, 137, 220, 0.7)',
                    borderColor: '#4a89dc',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Dives'
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %} 