{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/dive_log.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/my_logs.css') }}">
<style>
    /* Alert styling */
    .alert {
        padding: 12px 15px;
        border-radius: 4px;
        margin-bottom: 15px;
    }
    
    .alert-warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }
    
    .alert-danger {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    /* Share modal styling */
    .share-with-user {
        margin-top: 15px;
        position: relative;
    }
    
    .input-group {
        display: flex;
        margin-bottom: 10px;
    }
    
    .input-group input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px 0 0 4px;
        font-size: 14px;
    }
    
    .input-group button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 0 4px 4px 0;
        padding: 10px 15px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    
    .input-group button:hover {
        background-color: #0069d9;
    }
    
    .share-instructions {
        margin: 10px 0;
        font-size: 13px;
        color: #666;
    }
    
    .share-feedback {
        margin-top: 15px;
    }
    
    /* User suggestions styling */
    .user-suggestions {
        max-height: 150px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-top: -5px;
        margin-bottom: 10px;
        display: none;
        z-index: 2000;
        position: absolute;
        width: 100%;
        background-color: white;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .suggestion-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    
    .suggestion-item:last-child {
        border-bottom: none;
    }
    
    .suggestion-item:hover {
        background-color: #f5f5f5;
    }
    
    .suggestion-username {
        font-weight: bold;
    }
    
    .suggestion-email {
        color: #666;
        font-size: 0.9em;
        margin-left: 5px;
    }
    
    /* Invite section styling */
    .invite-section {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }
    
    .invite-section h4 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #555;
    }
    
    .invite-section p {
        margin-bottom: 15px;
        color: #666;
    }
    
    #copy-invite-link {
        background-color: #6c757d;
    }
    
    #copy-invite-link:hover {
        background-color: #5a6268;
    }
    
    /* Edit modal styling */
    .edit-modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: rgba(0,0,0,0.6);
        display: none;
    }
    
    .edit-modal-content {
        background-color: #fff;
        margin: 2% auto;
        padding: 20px;
        border-radius: 5px;
        width: 80%;
        max-width: 900px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 10px 0;
        display: flex;
        flex-direction: column;
        min-height: 300px; /* Ensure minimum height for modal content */
    }
    
    .edit-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 20px;
        flex-shrink: 0;
    }
    
    .edit-modal-header h3 {
        margin: 0;
    }
    
    .edit-form-section {
        margin-bottom: 20px;
    }
    
    .edit-form-section h4 {
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
        margin-bottom: 15px;
    }
    
    .edit-form-row {
        display: flex;
        flex-wrap: wrap;
        margin: 0 -10px;
    }
    
    .edit-form-group {
        flex: 1;
        min-width: 200px;
        padding: 0 10px;
        margin-bottom: 15px;
    }
    
    .edit-form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }
    
    .edit-form-group input,
    .edit-form-group select,
    .edit-form-group textarea {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .edit-form-group textarea {
        min-height: 80px;
        resize: vertical;
    }
    
    .edit-modal-footer {
        border-top: 1px solid #eee;
        padding-top: 15px;
        margin-top: 20px;
        display: flex;
        justify-content: flex-end;
        flex-shrink: 0;
    }
    
    .edit-modal-footer button {
        margin-left: 10px;
    }

    #edit-dive-form {
        height: 100%;
        overflow: visible;
    }

    /* Make sure loading and error divs don't scroll independently */
    #edit-loading, #edit-error {
        flex-shrink: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="my-logs-container">
    <div class="sidebar">
        <div class="filter-section">
            <h3>Filter Logs</h3>
            <form id="filter-form">
                <div class="filter-group">
                    <label for="date-from">Date From:</label>
                    <input type="date" id="date-from" name="date_from">
                </div>
                <div class="filter-group">
                    <label for="date-to">Date To:</label>
                    <input type="date" id="date-to" name="date_to">
                </div>
                <div class="filter-group">
                    <label for="location">Location:</label>
                    <select id="location" name="location">
                        <option value="">All Locations</option>
                        {% for location in locations %}
                        <option value="{{ location }}">{{ location }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label for="min-depth">Min Depth (m):</label>
                    <input type="number" id="min-depth" name="min_depth" min="0" max="100">
                </div>
                <div class="filter-group">
                    <label for="max-depth">Max Depth (m):</label>
                    <input type="number" id="max-depth" name="max_depth" min="0" max="100">
                </div>
                <button type="submit" class="btn filter-btn">Apply Filters</button>
                <button type="button" class="btn reset-btn">Reset</button>
            </form>
        </div>
    </div>

    <div class="main-content">
        <div class="page-header">
            <h1>My Dive Logs</h1>
            <div class="header-buttons">
                <a href="{{ url_for('main.diving_stats') }}" class="btn btn-stats">üìä Diving Stats</a>
                <a href="{{ url_for('main.new_log') }}" class="btn">+ Add New Log</a>
            </div>
        </div>

        {% if success_message %}
        <div class="success-message" id="success-message">
            <span>{{ success_message }}</span>
            <button type="button" onclick="this.parentElement.style.display='none';">&times;</button>
        </div>
        {% else %}
        <!-- Success message container for JavaScript-created messages -->
        <div class="success-message" id="js-success-message" style="display: none;">
            <span id="js-success-text"></span>
            <button type="button" onclick="this.parentElement.style.display='none';">&times;</button>
        </div>
        {% endif %}

        <script>
            // Check for success parameter in URL and display appropriate message
            document.addEventListener('DOMContentLoaded', function() {
                const urlParams = new URLSearchParams(window.location.search);
                const success = urlParams.get('success');
                const messageEl = document.getElementById('js-success-message');
                const textEl = document.getElementById('js-success-text');
                
                if (success === 'dive_created') {
                    textEl.textContent = 'Dive log created successfully!';
                    messageEl.style.display = 'block';
                    
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        messageEl.style.display = 'none';
                    }, 5000);
                    
                    // Remove the query parameter
                    history.replaceState(null, '', window.location.pathname);
                }
                else if (success === 'dive_created_with_profile') {
                    textEl.textContent = 'Dive log created successfully with dive profile data!';
                    messageEl.style.display = 'block';
                    
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        messageEl.style.display = 'none';
                    }, 5000);
                    
                    // Remove the query parameter
                    history.replaceState(null, '', window.location.pathname);
                }
            });
        </script>

        <div class="map-section">
            <h2>My Dive Map</h2>
            <div id="my-dive-map"></div>
        </div>

        <div class="logs-list">
            {% if dives %}
                {% for dive in dives %}
                <div class="log-card" data-dive-id="{{ dive.id }}" data-location="{{ dive.location }}" data-latitude="" data-longitude="">
                    <div class="log-header">
                        <h3>{{ dive.location }}</h3>
                        <span class="date">{{ dive.start_time.strftime('%B %d, %Y') }}</span>
                        {% if dive.profile_csv_data %}
                        <span class="badge computer-data">Dive Computer Data</span>
                        {% endif %}
                    </div>
                    <div class="log-details">
                        <div class="detail-item">
                            <span class="detail-icon">‚è±Ô∏è</span>
                            <span class="detail-label">Duration:</span>
                            <span class="detail-value">
                                {% if dive.start_time and dive.end_time %}
                                    {{ ((dive.end_time - dive.start_time).total_seconds() / 60)|round|int }} min
                                {% else %}
                                    -
                                {% endif %}
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-icon">üìè</span>
                            <span class="detail-label">Max Depth:</span>
                            <span class="detail-value">{{ dive.max_depth|round(1) }}m</span>
                        </div>
                        {% if dive.visibility %}
                        <div class="detail-item">
                            <span class="detail-icon">üëÅÔ∏è</span>
                            <span class="detail-label">Visibility:</span>
                            <span class="detail-value">{{ dive.visibility }}</span>
                        </div>
                        {% endif %}
                        {% if dive.weather %}
                        <div class="detail-item">
                            <span class="detail-icon">‚òÅÔ∏è</span>
                            <span class="detail-label">Weather:</span>
                            <span class="detail-value">{{ dive.weather }}</span>
                        </div>
                        {% endif %}
                    </div>
                    
                    {% if dive.profile_csv_data %}
                    <!-- Dive Profile Chart Section -->
                    <div class="dive-profile-section">
                        <h4>Dive Profile</h4>
                        <div class="profile-stats">
                            <div class="stat-box">
                                <span class="stat-label">Max Depth</span>
                                <span class="stat-value">{{ dive.max_depth|round(1) }} m</span>
                            </div>
                            <div class="stat-box">
                                <span class="stat-label">Avg Depth</span>
                                <span class="stat-value">18.2 m</span>
                            </div>
                            <div class="stat-box">
                                <span class="stat-label">Dive Time</span>
                                <span class="stat-value">
                                    {% if dive.start_time and dive.end_time %}
                                        {{ ((dive.end_time - dive.start_time).total_seconds() / 60)|round|int }} min
                                    {% else %}
                                        -
                                    {% endif %}
                                </span>
                            </div>
                            <div class="stat-box">
                                <span class="stat-label">Air Used</span>
                                <span class="stat-value">96 bar</span>
                            </div>
                            <div class="stat-box">
                                <span class="stat-label">Min Temp</span>
                                <span class="stat-value">21 ¬∞C</span>
                            </div>
                        </div>
                        <div class="dive-profile-chart-container">
                            <canvas id="dive-profile-chart-{{ dive.id }}" data-csv-data="{{ dive.profile_csv_data|e }}"></canvas>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if dive.dive_partner %}
                    <div class="log-buddies">
                        <span class="buddy-label">Dive Buddies:</span>
                        <div class="buddy-list">
                            <span class="buddy">{{ dive.dive_partner }}</span>
                        </div>
                    </div>
                    {% endif %}
                    {% if dive.notes %}
                    <div class="log-notes">
                        <p>{{ dive.notes }}</p>
                    </div>
                    {% endif %}
                    <div class="log-actions">
                        <a href="#" class="btn btn-small view-details" data-id="{{ dive.id }}">View Details</a>
                        <a href="#" class="btn btn-small edit-dive" data-id="{{ dive.id }}">Edit</a>
                        <a href="#" class="btn btn-small btn-delete delete-dive" data-id="{{ dive.id }}">Delete</a>
                        <button class="btn btn-small share-btn" data-id="{{ dive.id }}">Share</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="no-logs-message">
                    <p>You haven't logged any dives yet. Start by <a href="{{ url_for('main.new_log') }}">adding your first dive log</a>.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal" id="share-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Share Dive Log</h3>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <div class="share-with-user">
                <div class="input-group">
                    <input type="text" id="share-recipient" class="form-control" placeholder="Enter username or email address">
                    <button id="share-with-user-btn" class="btn btn-primary">Share</button>
                </div>
                <div id="user-suggestions" class="user-suggestions"></div>
                <div class="share-instructions">
                    <p>Enter a username or email address to share this dive log.</p>
                </div>
                <div id="share-user-feedback" class="share-feedback"></div>
                <div id="invite-section" class="invite-section" style="display: none;">
                    <hr>
                    <h4>Invite to Dive Logger</h4>
                    <p>This user doesn't have an account yet. Invite them to join!</p>
                    <div class="input-group">
                        <input type="text" id="invite-link" class="form-control" value="" readonly>
                        <button id="copy-invite-link" class="btn btn-secondary">Copy</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary close-btn">Close</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="delete-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Confirm Deletion</h3>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete this dive log? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary cancel-btn">Cancel</button>
            <button class="btn btn-delete confirm-delete-btn">Delete</button>
        </div>
    </div>
</div>

<!-- Edit Dive Log Modal -->
<div class="modal edit-modal" id="edit-modal">
    <div class="modal-content edit-modal-content">
        <div class="modal-header edit-modal-header">
            <h3>Edit Dive Log</h3>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <div id="edit-loading" class="loading">Loading dive data...</div>
            <form id="edit-dive-form" style="display: none;">
                <input type="hidden" id="edit-dive-id" name="id">
                
                <div class="edit-form-section">
                    <h4>Dive Information</h4>
                    <div class="edit-form-row">
                        <div class="edit-form-group">
                            <label for="edit-location">Dive Site Name*</label>
                            <input type="text" id="edit-location" name="location" required>
                        </div>
                        <div class="edit-form-group">
                            <label for="edit-start-time">Start Date & Time*</label>
                            <input type="datetime-local" id="edit-start-time" name="start_time" required>
                        </div>
                        <div class="edit-form-group">
                            <label for="edit-end-time">End Date & Time*</label>
                            <input type="datetime-local" id="edit-end-time" name="end_time" required>
                        </div>
                    </div>
                </div>
                
                <div class="edit-form-section">
                    <h4>Dive Details</h4>
                    <div class="edit-form-row">
                        <div class="edit-form-group">
                            <label for="edit-max-depth">Max Depth (meters)*</label>
                            <input type="number" id="edit-max-depth" name="max_depth" min="0" max="100" step="0.1" required>
                        </div>
                        <div class="edit-form-group">
                            <label for="edit-visibility">Visibility</label>
                            <input type="text" id="edit-visibility" name="visibility">
                        </div>
                        <div class="edit-form-group">
                            <label for="edit-weather">Weather Conditions</label>
                            <select id="edit-weather" name="weather">
                                <option value="sunny">Sunny</option>
                                <option value="cloudy">Cloudy</option>
                                <option value="rainy">Rainy</option>
                                <option value="stormy">Stormy</option>
                                <option value="windy">Windy</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="edit-form-section">
                    <h4>Equipment</h4>
                    <div class="edit-form-row">
                        <div class="edit-form-group">
                            <label for="edit-weight-belt">Weight (kg)</label>
                            <input type="number" id="edit-weight-belt" name="weight_belt" min="0" max="20" step="0.5">
                        </div>
                    </div>
                </div>
                
                <div class="edit-form-section">
                    <h4>Dive Buddies</h4>
                    <div class="edit-form-row">
                        <div class="edit-form-group">
                            <label for="edit-dive-partner">Dive Buddy/Partner</label>
                            <input type="text" id="edit-dive-partner" name="dive_partner">
                        </div>
                    </div>
                </div>
                
                <div class="edit-form-section">
                    <h4>Notes</h4>
                    <div class="edit-form-row">
                        <div class="edit-form-group">
                            <label for="edit-notes">Dive Notes</label>
                            <textarea id="edit-notes" name="notes" rows="4"></textarea>
                        </div>
                    </div>
                </div>
            </form>
            <div id="edit-error" class="alert alert-danger" style="display: none;"></div>
        </div>
        <div class="modal-footer edit-modal-footer">
            <div id="edit-feedback"></div>
            <button class="btn btn-secondary close-edit-btn">Cancel</button>
            <button class="btn btn-primary save-dive-btn">Save Changes</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
<script src="{{ url_for('static', filename='js/dive_profile_chart.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Check URL for edit_dive parameter
        const urlParams = new URLSearchParams(window.location.search);
        const editDiveId = urlParams.get('edit_dive');
        
        if (editDiveId) {
            // Open edit modal with the specified dive ID
            openEditModal(editDiveId);
        }
        
        // Initialize the map
        initMap();
        
        // Setup event listeners
        setupEventListeners();
        
        // Setup modals
        setupModals();
        
        // Auto-hide success message after 5 seconds
        const successMessage = document.getElementById('success-message');
        if (successMessage) {
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }
    });

    // Helper function for API requests
    async function apiRequest(url, method = 'GET', data = null) {
        // Get CSRF token
        const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        const options = {
            method: method,
            headers: {
                'X-CSRFToken': token
            }
        };
        
        if (data) {
            options.headers['Content-Type'] = 'application/json';
            options.body = JSON.stringify(data);
        }
        
        const response = await fetch(url, options);
        
        if (!response.ok) {
            const errorText = await response.text();
            try {
                const errorJson = JSON.parse(errorText);
                throw new Error(errorJson.error || `HTTP error ${response.status}`);
            } catch (e) {
                if (e instanceof SyntaxError) {
                    throw new Error(`HTTP error ${response.status}: ${errorText}`);
                } else {
                    throw e;
                }
            }
        }
        
        // For DELETE requests, just return success, no data
        if (method === 'DELETE') {
            return { success: true };
        }
        
        // For GET, POST, PUT requests, return the parsed JSON response
        try {
            return await response.json();
        } catch (e) {
            return { success: true }; // For endpoints that don't return JSON
        }
    }

    function initMap() {
        // Check if map container exists
        const mapContainer = document.getElementById('my-dive-map');
        if (!mapContainer) return;

        // Initialize the map with noWrap to prevent repeating world
        const map = L.map('my-dive-map', {
            worldCopyJump: false,
            maxBounds: [[-90, -180], [90, 180]],
            minZoom: 2
        }).setView([0, 0], 2);

        // Add OpenStreetMap tiles with noWrap option
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19,
            noWrap: true
        }).addTo(map);

        // Attempt to add OpenSeaMap tiles
        try {
            L.tileLayer('https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openseamap.org/">OpenSeaMap</a> contributors',
                maxZoom: 19,
                noWrap: true
            }).addTo(map);
        } catch (e) {
            console.warn('Failed to load OpenSeaMap tiles:', e);
        }

        // Create default icon
        const defaultIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
            shadowSize: [41, 41]
        });

        // Create a bounds object to fit all dive sites
        const bounds = L.latLngBounds();
        let hasValidMarkers = false;
        
        // Store coordinates to normalize them
        const coordinates = [];

        // First pass - collect all coordinates and normalize longitudes
        const logCards = document.querySelectorAll('.log-card');
        logCards.forEach(card => {
            const location = card.dataset.location;
            let lat = parseFloat(card.dataset.latitude);
            let lng = parseFloat(card.dataset.longitude);
            
            // Try to extract coordinates from location string if not provided
            if (isNaN(lat) || isNaN(lng)) {
                const coordsMatch = location.match(/\((-?\d+\.\d+),\s*(-?\d+\.\d+)\)/);
                if (coordsMatch) {
                    lat = parseFloat(coordsMatch[1]);
                    lng = parseFloat(coordsMatch[2]);
                    
                    // Store the extracted coordinates in the card
                    card.dataset.latitude = lat;
                    card.dataset.longitude = lng;
                }
            }
            
            // Skip if no valid coordinates
            if (isNaN(lat) || isNaN(lng)) return;
            
            // Normalize longitude to -180 to 180 range
            while (lng > 180) lng -= 360;
            while (lng < -180) lng += 360;
            
            coordinates.push({card, lat, lng, location});
        });
        
        // Calculate the center of all points to determine which side of the map to use
        if (coordinates.length > 0) {
            // Create markers after normalizing coordinates
            coordinates.forEach(({card, lat, lng, location}) => {
                hasValidMarkers = true;
                
                // Create marker
                const marker = L.marker([lat, lng], {
                    icon: defaultIcon,
                    alt: location
                }).addTo(map);
                
                // Create popup content
                const diveId = card.dataset.diveId;
                const diveDate = card.querySelector('.date').textContent;
                const diveDetails = Array.from(card.querySelectorAll('.detail-item')).map(item => {
                    const label = item.querySelector('.detail-label').textContent;
                    const value = item.querySelector('.detail-value').textContent;
                    return `<div class="popup-detail"><strong>${label}</strong> ${value}</div>`;
                }).join('');
                
                const popupContent = `
                    <div class="dive-log-popup">
                        <h3>${location}</h3>
                        <div class="dive-date">${diveDate}</div>
                        <div class="dive-log-details">
                            ${diveDetails}
                        </div>
                        <div class="popup-actions">
                            <a href="#" class="popup-link view-details" data-id="${diveId}">View Details</a>
                        </div>
                    </div>
                `;
                
                // Bind popup to marker
                marker.bindPopup(popupContent, {
                    maxWidth: 300
                });
                
                // Add this location to bounds
                bounds.extend([lat, lng]);
            });
        }

        // Fit the map to show all dive sites with some padding
        if (hasValidMarkers && bounds.isValid()) {
            map.fitBounds(bounds, {
                padding: [50, 50],
                maxZoom: 10
            });
        }
    }

    function setupEventListeners() {
        // Filter form submission
        const filterForm = document.getElementById('filter-form');
        if (filterForm) {
            filterForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Get form data
                const formData = new FormData(filterForm);
                const queryParams = new URLSearchParams();
                
                // Add form data to query parameters
                for (const [key, value] of formData.entries()) {
                    if (value) queryParams.append(key, value);
                }
                
                // Redirect to filtered URL
                window.location.href = `${window.location.pathname}?${queryParams.toString()}`;
            });
        }
        
        // Reset filters button
        const resetBtn = document.querySelector('.reset-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', function() {
                // Reset all form fields
                filterForm.reset();
                
                // Redirect to unfiltered URL
                window.location.href = window.location.pathname;
            });
        }
        
        // View details buttons
        const viewDetailsButtons = document.querySelectorAll('.view-details');
        viewDetailsButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const diveId = this.dataset.id;
                // Redirect to dive details page
                window.location.href = `/dive/${diveId}`;
            });
        });
        
        // Edit buttons
        const editButtons = document.querySelectorAll('.edit-dive');
        editButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const diveId = this.dataset.id;
                // Open edit modal with dive data
                openEditModal(diveId);
            });
        });
        
        // Delete buttons
        const deleteButtons = document.querySelectorAll('.delete-dive');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const diveId = this.dataset.id;
                
                // Store dive ID in delete modal
                document.getElementById('delete-modal').dataset.diveId = diveId;
                
                // Show delete confirmation modal
                document.getElementById('delete-modal').style.display = 'block';
            });
        });
        
        // Share buttons
        const shareButtons = document.querySelectorAll('.share-btn');
        shareButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const diveId = this.dataset.id;
                const diveLocation = this.closest('.log-card').querySelector('h3').textContent;
                
                // Store dive ID in share modal
                document.getElementById('share-modal').dataset.diveId = diveId;
                
                // Update modal title
                document.querySelector('#share-modal .modal-header h3').textContent = `Share - ${diveLocation}`;
                
                // Show share modal
                document.getElementById('share-modal').style.display = 'block';
            });
        });
    }

    // Function to fetch dive data and open edit modal
    async function openEditModal(diveId) {
        try {
            // Show loading state
            const editModal = document.getElementById('edit-modal');
            const loadingEl = document.getElementById('edit-loading');
            const formEl = document.getElementById('edit-dive-form');
            const errorEl = document.getElementById('edit-error');
            
            // Reset state
            loadingEl.style.display = 'block';
            formEl.style.display = 'none';
            errorEl.style.display = 'none';
            
            // Show modal
            editModal.style.display = 'block';
            
            try {
                // Fetch dive data
                const dive = await apiRequest(`/api/dives/${diveId}`);
                
                // Populate form fields with dive data
                formEl.querySelector('#edit-dive-id').value = dive.id;
                formEl.querySelector('#edit-location').value = dive.location || '';
                
                // Format datetime-local inputs
                if (dive.start_time) {
                    const startTime = new Date(dive.start_time);
                    formEl.querySelector('#edit-start-time').value = formatDateTimeLocalInput(startTime);
                }
                
                if (dive.end_time) {
                    const endTime = new Date(dive.end_time);
                    formEl.querySelector('#edit-end-time').value = formatDateTimeLocalInput(endTime);
                }
                
                formEl.querySelector('#edit-max-depth').value = dive.max_depth || '';
                formEl.querySelector('#edit-visibility').value = dive.visibility || '';
                formEl.querySelector('#edit-weather').value = dive.weather || 'sunny';
                formEl.querySelector('#edit-weight-belt').value = dive.weight_belt || '';
                formEl.querySelector('#edit-dive-partner').value = dive.dive_partner || '';
                formEl.querySelector('#edit-notes').value = dive.notes || '';
                
                // Hide loading, show form
                loadingEl.style.display = 'none';
                formEl.style.display = 'block';
            } catch (error) {
                console.error('Error fetching dive data:', error);
                loadingEl.style.display = 'none';
                errorEl.textContent = 'Error loading dive data: ' + error.message;
                errorEl.style.display = 'block';
            }
        } catch (error) {
            console.error('General error in openEditModal:', error);
            alert('Error opening edit form: ' + error.message);
        }
    }

    // Helper function to format date for datetime-local input
    function formatDateTimeLocalInput(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    function setupModals() {
        // Setup Share Modal
        const shareModal = document.getElementById('share-modal');
        const shareCloseBtn = shareModal.querySelector('.close-modal');
        const shareCloseFooterBtn = shareModal.querySelector('.close-btn');
        
        if (shareCloseBtn) {
            shareCloseBtn.addEventListener('click', function() {
                shareModal.style.display = 'none';
            });
        }
        
        if (shareCloseFooterBtn) {
            shareCloseFooterBtn.addEventListener('click', function() {
                shareModal.style.display = 'none';
            });
        }
        
        // Share with specific user functionality
        const shareWithUserBtn = document.getElementById('share-with-user-btn');
        const shareUserFeedback = document.getElementById('share-user-feedback');
        const userSuggestions = document.getElementById('user-suggestions');
        const shareRecipient = document.getElementById('share-recipient');
        const inviteSection = document.getElementById('invite-section');
        const inviteLink = document.getElementById('invite-link');
        const copyInviteBtn = document.getElementById('copy-invite-link');
        
        let suggestionTimeout;
        
        // User search functionality
        if (shareRecipient) {
            // Focus event - when input gets focus, show suggestions if there are any
            shareRecipient.addEventListener('focus', function() {
                if (userSuggestions.children.length > 0) {
                    userSuggestions.style.display = 'block';
                }
            });
            
            shareRecipient.addEventListener('input', function() {
                const query = this.value.trim();
                
                // Clear previous timeout
                if (suggestionTimeout) {
                    clearTimeout(suggestionTimeout);
                }
                
                // Hide suggestions if input is empty
                if (!query) {
                    userSuggestions.style.display = 'none';
                    return;
                }
                
                // Debounce the search to avoid too many requests
                suggestionTimeout = setTimeout(async function() {
                    if (query.length < 2) return;
                    
                    try {
                        // Get CSRF token
                        const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                        
                        // Make API request to search users
                        const response = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
                        
                        if (!response.ok) {
                            console.error('Error searching users:', await response.text());
                            return;
                        }
                        
                        const data = await response.json();
                        
                        // Display user suggestions
                        userSuggestions.innerHTML = '';
                        
                        if (data.users.length === 0) {
                            userSuggestions.style.display = 'none';
                            return;
                        }
                        
                        // Create suggestion items
                        data.users.forEach(user => {
                            const item = document.createElement('div');
                            item.className = 'suggestion-item';
                            item.innerHTML = `
                                <span class="suggestion-username">${user.username}</span>
                                <span class="suggestion-email">${user.email}</span>
                            `;
                            
                            // Select user when clicked
                            item.addEventListener('click', function() {
                                // Always use username for sharing
                                shareRecipient.value = user.username;
                                userSuggestions.style.display = 'none';
                            });
                            
                            userSuggestions.appendChild(item);
                        });
                        
                        userSuggestions.style.display = 'block';
                    } catch (error) {
                        console.error('Error searching users:', error);
                    }
                }, 300);
            });
            
            // Handle clicks outside to hide suggestions
            document.addEventListener('click', function(e) {
                if (!shareRecipient.contains(e.target) && !userSuggestions.contains(e.target)) {
                    userSuggestions.style.display = 'none';
                }
            });
        }
        
        // Copy invite link functionality
        if (copyInviteBtn) {
            copyInviteBtn.addEventListener('click', function() {
                inviteLink.select();
                document.execCommand('copy');
                
                const originalText = this.textContent;
                this.textContent = 'Copied!';
                
                setTimeout(() => {
                    this.textContent = originalText;
                }, 2000);
            });
        }
        
        if (shareWithUserBtn) {
            shareWithUserBtn.addEventListener('click', async function() {
                const recipient = shareRecipient.value.trim();
                const diveId = shareModal.dataset.diveId;
                
                if (!recipient) {
                    shareUserFeedback.innerHTML = '<div class="alert alert-warning">Please enter a username or email address</div>';
                    return;
                }
                
                try {
                    // Show loading state
                    shareWithUserBtn.disabled = true;
                    shareWithUserBtn.textContent = 'Sharing...';
                    
                    // Get CSRF token
                    const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                    
                    // Hide invite section if previously shown
                    inviteSection.style.display = 'none';
                    
                    // Make API request to share with user
                    const response = await fetch(`/api/shared/dives/${diveId}/share-with-user`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': token
                        },
                        body: JSON.stringify({
                            username: recipient
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.status === 404) {
                        // Handle user not found errors
                        // Show the invite section
                        inviteSection.style.display = 'block';
                        
                        // Generate invite link
                        const signupURL = `${window.location.origin}/register`;
                        inviteLink.value = signupURL;
                        
                        // Show error message
                        const recipientType = recipient.includes('@') ? 'email address' : 'username';
                        shareUserFeedback.innerHTML = `<div class="alert alert-warning">No user found with this ${recipientType}. You can invite them to sign up!</div>`;
                        return;
                    }
                    
                    if (!response.ok) {
                        shareUserFeedback.innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to share dive. Please try again.'}</div>`;
                        return;
                    }
                    
                    // Show success message
                    shareUserFeedback.innerHTML = `<div class="alert alert-success">${data.message || 'Dive successfully shared!'}</div>`;
                    
                    // Clear input
                    shareRecipient.value = '';
                    
                } catch (error) {
                    console.error('Error sharing with user:', error);
                    shareUserFeedback.innerHTML = '<div class="alert alert-danger">An error occurred. Please try again.</div>';
                } finally {
                    // Reset button state
                    shareWithUserBtn.disabled = false;
                    shareWithUserBtn.textContent = 'Share';
                }
            });
        }
        
        // Setup Delete Confirmation Modal
        const deleteModal = document.getElementById('delete-modal');
        const deleteCloseBtn = deleteModal.querySelector('.close-modal');
        const deleteCancelBtn = deleteModal.querySelector('.cancel-btn');
        const deleteConfirmBtn = deleteModal.querySelector('.confirm-delete-btn');
        
        if (deleteCloseBtn) {
            deleteCloseBtn.addEventListener('click', function() {
                deleteModal.style.display = 'none';
            });
        }
        
        if (deleteCancelBtn) {
            deleteCancelBtn.addEventListener('click', function() {
                deleteModal.style.display = 'none';
            });
        }
        
        if (deleteConfirmBtn) {
            deleteConfirmBtn.addEventListener('click', async function() {
                const diveId = deleteModal.dataset.diveId;
                
                try {
                    // Use the centralized API request function with CSRF protection
                    await apiRequest(`/api/dives/${diveId}`, 'DELETE');
                    
                    // Remove the dive card from the page
                    const diveCard = document.querySelector(`.log-card[data-dive-id="${diveId}"]`);
                    if (diveCard) {
                        diveCard.remove();
                    }
                    
                    // Close modal
                    deleteModal.style.display = 'none';
                    
                    // Show success message
                    alert('Dive log deleted successfully');
                    
                    // Reload page to update stats
                    window.location.reload();
                } catch (error) {
                    console.error('Error deleting dive log:', error);
                    alert('Error deleting dive log: ' + error.message);
                }
            });
        }
        
        // Setup Edit Modal
        const editModal = document.getElementById('edit-modal');
        const editCloseBtn = editModal.querySelector('.close-modal');
        const editCancelBtn = editModal.querySelector('.close-edit-btn');
        const editSaveBtn = editModal.querySelector('.save-dive-btn');
        
        if (editCloseBtn) {
            editCloseBtn.addEventListener('click', function() {
                editModal.style.display = 'none';
            });
        }
        
        if (editCancelBtn) {
            editCancelBtn.addEventListener('click', function() {
                editModal.style.display = 'none';
            });
        }
        
        if (editSaveBtn) {
            editSaveBtn.addEventListener('click', async function() {
                // Get form data
                const form = document.getElementById('edit-dive-form');
                const diveId = form.querySelector('#edit-dive-id').value;
                const feedbackEl = document.getElementById('edit-feedback');
                
                try {
                    // Show loading state
                    editSaveBtn.disabled = true;
                    editSaveBtn.textContent = 'Saving...';
                    
                    // Prepare data
                    const formData = {
                        location: form.querySelector('#edit-location').value,
                        start_time: form.querySelector('#edit-start-time').value,
                        end_time: form.querySelector('#edit-end-time').value,
                        max_depth: parseFloat(form.querySelector('#edit-max-depth').value),
                        visibility: form.querySelector('#edit-visibility').value,
                        weather: form.querySelector('#edit-weather').value,
                        weight_belt: parseFloat(form.querySelector('#edit-weight-belt').value) || null,
                        dive_partner: form.querySelector('#edit-dive-partner').value,
                        notes: form.querySelector('#edit-notes').value
                    };
                    
                    // Send update request
                    await apiRequest(`/api/dives/${diveId}`, 'PUT', formData);
                    
                    // Hide modal
                    editModal.style.display = 'none';
                    
                    // Show success message
                    const messageEl = document.getElementById('js-success-message');
                    const textEl = document.getElementById('js-success-text');
                    textEl.textContent = 'Dive log updated successfully!';
                    messageEl.style.display = 'block';
                    
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        messageEl.style.display = 'none';
                    }, 5000);
                    
                    // Reload page to show updated data
                    window.location.reload();
                } catch (error) {
                    console.error('Error updating dive log:', error);
                    
                    // Show error feedback
                    feedbackEl.innerHTML = `<div class="alert alert-danger">${error.message || 'Error updating dive log'}</div>`;
                    
                    // Auto-hide error after 5 seconds
                    setTimeout(() => {
                        feedbackEl.innerHTML = '';
                    }, 5000);
                } finally {
                    // Reset button state
                    editSaveBtn.disabled = false;
                    editSaveBtn.textContent = 'Save Changes';
                }
            });
        }
        
        // Close modals when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target === editModal) {
                editModal.style.display = 'none';
            }
            
            if (e.target === shareModal) {
                shareModal.style.display = 'none';
            }
            
            if (e.target === deleteModal) {
                deleteModal.style.display = 'none';
            }
        });
    }
</script>
{% endblock %} 