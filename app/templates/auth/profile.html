{% extends "base.html" %}

{% block styles %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<!-- Add a hidden form for direct submission if needed -->
<form id="direct-profile-form" action="/api/users/me" method="POST" style="display: none;">
  <input type="hidden" name="_method" value="PUT">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <input type="hidden" name="username" id="direct-username">
  <input type="hidden" name="email" id="direct-email">
  <input type="hidden" name="firstname" id="direct-firstname">
  <input type="hidden" name="lastname" id="direct-lastname">
  <input type="hidden" name="bio" id="direct-bio">
  <input type="hidden" name="dob" id="direct-dob">
  <input type="hidden" name="avatar" id="direct-avatar">
</form>
<style>
    .profile-container {
        max-width: 800px;
        margin: 2rem auto;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        background-color: #fff;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: bold;
    }
    
    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
    }
    
    .form-control:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }
    
    .btn-primary {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
    }
    
    .btn-primary:hover {
        background-color: #0069d9;
    }
    
    .btn-danger {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
    }
    
    .btn-danger:hover {
        background-color: #c82333;
    }
    
    .error-message {
        color: #dc3545;
        font-size: 14px;
        margin-top: 0.5rem;
        display: none;
    }
    
    .success-message {
        color: #28a745;
        font-size: 14px;
        padding: 0.75rem;
        margin-bottom: 1rem;
        background-color: #d4edda;
        border-radius: 4px;
        display: none;
    }
    
    .form-title {
        margin-bottom: 2rem;
        color: #343a40;
    }
    
    .btn-container {
        display: flex;
        justify-content: space-between;
        margin-top: 2rem;
    }
    
    .profile-info {
        display: flex;
        margin-bottom: 2rem;
    }
    
    .profile-avatar {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background-color: #eee;
        margin-right: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    
    .profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .profile-details {
        flex: 1;
    }
    
    .profile-username {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .profile-email {
        color: #6c757d;
        margin-bottom: 1rem;
    }
    
    .tab-container {
        margin-bottom: 2rem;
    }
    
    .tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
        margin-bottom: 1.5rem;
    }
    
    .tab {
        padding: 0.75rem 1.5rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }
    
    .tab.active {
        border-bottom: 2px solid #007bff;
        font-weight: bold;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .deactivate-section {
        margin-top: 3rem;
        padding-top: 2rem;
        border-top: 1px solid #ddd;
    }
    
    .deactivate-section h3 {
        color: #dc3545;
        margin-bottom: 1rem;
    }
    
    .deactivate-section p {
        margin-bottom: 1rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="success-message" id="success-message"></div>
    <div id="loading-message" style="text-align: center; display: block; margin-bottom: 1rem;">
        Loading your profile information...
        <div id="retry-container" style="display: none; margin-top: 10px;">
            <button id="retry-button" class="btn-primary" style="padding: 5px 10px; font-size: 14px;">Retry</button>
        </div>
    </div>

    <div class="profile-info">
        <div class="profile-avatar">
            <img id="avatar-img" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAIAQMAAAD+wSzIAAAABlBMVEX///+/v7+jQ3Y5AAAADklEQVQI12P4AIX8EAgALgAD/aNpbtEAAAAASUVORK5CYII" alt="Profile Picture">
        </div>
        <div class="profile-details">
            <h2 class="profile-username" id="display-username">Loading...</h2>
            <div class="profile-email" id="display-email">Loading...</div>
            <div>Member since: <span id="display-registration-date">Loading...</span></div>
        </div>
    </div>

    <div class="tab-container">
        <div class="tabs">
            <div class="tab active" data-tab="profile">Profile Information</div>
            <div class="tab" data-tab="security">Security</div>
        </div>

        <div class="tab-content active" id="profile-tab">
            <form id="profile-form" method="POST" action="/api/users/me">
                <input type="hidden" name="_method" value="PUT">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" class="form-control">
                    <div id="username-error" class="error-message"></div>
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" class="form-control">
                    <div id="email-error" class="error-message"></div>
                </div>

                <div class="form-group">
                    <label for="firstname">First Name</label>
                    <input type="text" id="firstname" name="firstname" class="form-control">
                </div>

                <div class="form-group">
                    <label for="lastname">Last Name</label>
                    <input type="text" id="lastname" name="lastname" class="form-control">
                </div>

                <div class="form-group">
                    <label for="bio">Bio</label>
                    <textarea id="bio" name="bio" rows="4" class="form-control"></textarea>
                </div>

                <div class="form-group">
                    <label for="dob">Date of Birth</label>
                    <input type="date" id="dob" name="dob" class="form-control">
                </div>

                <div class="form-group">
                    <label for="avatar-url">Avatar URL</label>
                    <input type="text" id="avatar-url" name="avatar" class="form-control">
                </div>

                <div class="btn-container">
                    <button type="submit" class="btn-primary">Save Changes</button>
                </div>
            </form>
        </div>

        <div class="tab-content" id="security-tab">
            <form id="change-password-form" method="POST" action="/api/auth/reset-password">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div id="error-container" class="error-message" style="margin-bottom: 1rem; display: none;"></div>
                <div id="password-success-message" class="success-message" style="display: none;"></div>
                
                <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input type="password" id="current-password" name="current_password" class="form-control" required>
                    <div id="current-password-error" class="error-message"></div>
                </div>

                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" name="new_password" class="form-control" required>
                    <div class="password-requirements">
                        Must be at least 8 characters with uppercase, lowercase, and a number
                    </div>
                    <div id="new-password-error" class="error-message"></div>
                </div>

                <div class="form-group">
                    <label for="confirm-password">Confirm New Password</label>
                    <input type="password" id="confirm-password" name="confirm_password" class="form-control" required>
                    <div id="confirm-password-error" class="error-message"></div>
                </div>

                <div class="btn-container">
                    <button type="submit" class="btn-primary">Change Password</button>
                </div>
            </form>

            <div class="deactivate-section">
                <h3>Deactivate Account</h3>
                <p>Warning: Deactivating your account will make your profile and data inaccessible. This action is reversible by contacting support.</p>
                <button id="deactivate-button" class="btn-danger">Deactivate Account</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const profileForm = document.getElementById('profile-form');
        const changePasswordForm = document.getElementById('change-password-form');
        const deactivateButton = document.getElementById('deactivate-button');
        const successMessage = document.getElementById('success-message');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const retryButton = document.getElementById('retry-button');
        
        // Add event listener for retry button
        if (retryButton) {
            retryButton.addEventListener('click', function() {
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) {
                    loadingMessage.textContent = 'Loading your profile information...';
                    loadingMessage.style.color = '';
                    document.getElementById('retry-container').style.display = 'none';
                }
                loadUserProfile();
            });
        }
        
        // Load user profile data immediately when the page loads
        console.log('DOM content loaded, loading user profile...');
        loadUserProfile();
        
        // Tab switching
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Remove active class from all tabs and contents
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                
                // Add active class to selected tab and content
                this.classList.add('active');
                document.getElementById(tabId + '-tab').classList.add('active');
                
                // Clear any error messages when switching tabs
                document.querySelectorAll('.error-message').forEach(el => {
                    el.style.display = 'none';
                    el.textContent = '';
                });
                
                // Clear success messages
                if (successMessage) {
                    successMessage.style.display = 'none';
                    successMessage.textContent = '';
                }
                
                const passwordSuccessMessage = document.getElementById('password-success-message');
                if (passwordSuccessMessage) {
                    passwordSuccessMessage.style.display = 'none';
                    passwordSuccessMessage.textContent = '';
                }
            });
        });
        
        // Profile form submission
        if (profileForm) {
            profileForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Reset previous error messages
                document.querySelectorAll('.error-message').forEach(el => {
                    el.style.display = 'none';
                    el.textContent = '';
                });
                successMessage.style.display = 'none';
                
                try {
                    let csrfToken = '';
                    
                    try {
                        // 首先尝试从开发端点获取CSRF令牌
                        const tokenApiUrl = window.location.origin + '/dev/get-csrf-token';
                        console.log('Getting CSRF token from:', tokenApiUrl);
                        
                        const tokenResponse = await fetch(tokenApiUrl, {
                            method: 'GET',
                            credentials: 'include'
                        });
                        
                        if (tokenResponse.ok) {
                            try {
                                const tokenData = await tokenResponse.json();
                                csrfToken = tokenData.csrf_token;
                                console.log('Got CSRF token');
                            } catch (jsonError) {
                                console.error('Error parsing CSRF token response:', jsonError);
                            }
                        } else {
                            // If development endpoint is not available, try to get from META tag
                            console.warn('CSRF token endpoint not available');
                            const metaToken = document.querySelector('meta[name="csrf-token"]');
                            if (metaToken) {
                                csrfToken = metaToken.getAttribute('content');
                                console.log('Got CSRF token from meta tag');
                            }
                        }
                    } catch (tokenError) {
                        console.warn('Error getting CSRF token:', tokenError);
                        // Continue without token in development
                    }
                    
                    // Prepare profile data
                    const profileData = {
                        username: document.getElementById('username').value,
                        email: document.getElementById('email').value,
                        firstname: document.getElementById('firstname').value,
                        lastname: document.getElementById('lastname').value,
                        bio: document.getElementById('bio').value,
                        avatar: document.getElementById('avatar-url').value,
                    };
                    
                    // Add dob only if it has a value
                    const dob = document.getElementById('dob').value;
                    if (dob) {
                        profileData.dob = dob;
                    }
                    
                    // Prepare headers
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    
                    // Add CSRF token if available
                    if (csrfToken) {
                        headers['X-CSRFToken'] = csrfToken;
                    }
                    
                    console.log('Sending profile update with data:', profileData);
                    
                    // 确保使用完整的URL，包括主机和端口
                    const apiUrl = window.location.origin + '/api/users/me';
                    console.log('Using API URL:', apiUrl);
                    
                    // 发送更新请求
                    let response;
                    try {
                        // 显示请求状态
                        successMessage.textContent = 'Saving changes...';
                        successMessage.style.display = 'block';
                        successMessage.style.backgroundColor = '#e2f3fd';
                        successMessage.style.color = '#0c5460';
                        
                        // 记录完整的请求头信息
                        console.log('Request headers:', headers);
                        
                        response = await fetch(apiUrl, {
                            method: 'PUT',
                            headers: headers,
                            credentials: 'include',
                            body: JSON.stringify(profileData)
                        });
                        console.log('API response status:', response.status, response.statusText);
                        
                        // 如果遇到任何HTTP错误状态码，显示详细信息
                        if (!response.ok) {
                            console.error('Error response status:', response.status, response.statusText);
                        }
                    } catch (fetchError) {
                        console.error('Fetch error when calling API:', fetchError);
                        throw new Error('Network error when connecting to API: ' + fetchError.message);
                    }
                    
                    // 处理404错误 - API端点不存在
                    if (response.status === 404) {
                        // 尝试替代路径 - 有时URL前缀可能有问题
                        console.log('API endpoint not found, trying alternative URL');
                        
                        try {
                            // 尝试不带origin的路径
                            const altApiUrl = '/api/users/me';
                            console.log('Trying alternative API URL:', altApiUrl);
                            
                            response = await fetch(altApiUrl, {
                                method: 'PUT',
                                headers: headers,
                                credentials: 'include',
                                body: JSON.stringify(profileData)
                            });
                            console.log('Alternative API response status:', response.status, response.statusText);
                            
                            if (response.status === 404) {
                                console.error('Alternative API endpoint also not found');
                                // 如果API不可用，尝试直接提交表单
                                console.log('Trying direct form submission');
                                
                                // 尝试直接使用表单提交
                                try {
                                    // 填充隐藏表单
                                    document.getElementById('direct-username').value = profileData.username;
                                    document.getElementById('direct-email').value = profileData.email;
                                    document.getElementById('direct-firstname').value = profileData.firstname;
                                    document.getElementById('direct-lastname').value = profileData.lastname;
                                    document.getElementById('direct-bio').value = profileData.bio;
                                    if (profileData.dob) {
                                        document.getElementById('direct-dob').value = profileData.dob;
                                    }
                                    if (profileData.avatar) {
                                        document.getElementById('direct-avatar').value = profileData.avatar;
                                    }
                                    
                                    // 显示提交中消息
                                    successMessage.textContent = 'Trying alternative submission method...';
                                    successMessage.style.display = 'block';
                                    successMessage.style.backgroundColor = '#e2f3fd';
                                    successMessage.style.color = '#0c5460';
                                    
                                    // 提交表单
                                    const directForm = document.getElementById('direct-profile-form');
                                    directForm.submit();
                                    return; // 停止执行后续代码
                                } catch (formError) {
                                    console.error('Form submission error:', formError);
                                    // 如果直接提交也失败了，显示错误消息
                                    successMessage.textContent = 'Error: Cannot update profile. Please try again later.';
                                    successMessage.style.backgroundColor = '#f8d7da';
                                    successMessage.style.color = '#721c24';
                                    
                                    // 更新显示元素，但只是UI更新
                                    document.getElementById('display-username').textContent = profileData.username;
                                    document.getElementById('display-email').textContent = profileData.email;
                                    return;
                                }
                            }
                        } catch (altFetchError) {
                            console.error('Error with alternative API URL:', altFetchError);
                        }
                    }
                    
                    try {
                        // 假设响应可能不是JSON格式
                        let data;
                        const responseText = await response.text();
                        console.log('Raw API response:', responseText);
                        
                        try {
                            // 尝试解析JSON
                            data = JSON.parse(responseText);
                        } catch (jsonError) {
                            console.error('Error parsing JSON response:', jsonError);
                            throw new Error('Invalid JSON response: ' + responseText);
                        }
                        
                        console.log('Parsed API response data:', data);

                        if (!response.ok) {
                            // 处理验证错误
                            if (data.error) {
                                if (data.error.includes('Username already in use')) {
                                    const errorEl = document.getElementById('username-error');
                                    errorEl.textContent = 'Username already in use';
                                    errorEl.style.display = 'block';
                                } else if (data.error.includes('Email already in use')) {
                                    const errorEl = document.getElementById('email-error');
                                    errorEl.textContent = 'Email already in use';
                                    errorEl.style.display = 'block';
                                } else if (data.error.includes('Invalid email')) {
                                    const errorEl = document.getElementById('email-error');
                                    errorEl.textContent = 'Invalid email format';
                                    errorEl.style.display = 'block';
                                } else {
                                    // Display the error in the success message area with red color
                                    successMessage.textContent = 'Update error: ' + data.error;
                                    successMessage.style.display = 'block';
                                    successMessage.style.backgroundColor = '#f8d7da';
                                    successMessage.style.color = '#721c24';
                                }
                            } else {
                                // Display general error
                                successMessage.textContent = 'An error occurred while updating your profile';
                                successMessage.style.display = 'block';
                                successMessage.style.backgroundColor = '#f8d7da';
                                successMessage.style.color = '#721c24';
                            }
                            return;
                        }
                        
                        // Success - update UI
                        successMessage.textContent = 'Profile updated successfully';
                        successMessage.style.display = 'block';
                        successMessage.style.backgroundColor = '#d4edda';
                        successMessage.style.color = '#28a745';
                        
                        // Update display elements
                        document.getElementById('display-username').textContent = data.user.username;
                        document.getElementById('display-email').textContent = data.user.email;
                        
                        // Update avatar if provided
                        if (data.user.avatar) {
                            document.getElementById('avatar-img').src = data.user.avatar;
                        }
                    } catch (error) {
                        console.error('Update error:', error);
                        
                        // Show error to user
                        successMessage.textContent = 'An error occurred while updating your profile: ' + error.message;
                        successMessage.style.display = 'block';
                        successMessage.style.backgroundColor = '#f8d7da';
                        successMessage.style.color = '#721c24';
                    }
                } catch (error) {
                    console.error('Update error:', error);
                    
                    // Show error to user
                    successMessage.textContent = 'An error occurred while updating your profile: ' + error.message;
                    successMessage.style.display = 'block';
                    successMessage.style.backgroundColor = '#f8d7da';
                    successMessage.style.color = '#721c24';
                }
            });
        }
        
        // Change password form submission
        if (changePasswordForm) {
            changePasswordForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Reset previous error messages
                document.querySelectorAll('.error-message').forEach(el => {
                    el.style.display = 'none';
                    el.textContent = '';
                });
                
                // Hide success message
                const successMessage = document.getElementById('success-message');
                if (successMessage) {
                    successMessage.style.display = 'none';
                }
                
                // Get password success message element
                const passwordSuccessMessage = document.getElementById('password-success-message');
                passwordSuccessMessage.textContent = '';
                passwordSuccessMessage.style.display = 'none';
                
                // Validate password match
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                if (!currentPassword) {
                    const errorEl = document.getElementById('current-password-error');
                    errorEl.textContent = 'Current password is required';
                    errorEl.style.display = 'block';
                    return;
                }
                
                if (!newPassword) {
                    const errorEl = document.getElementById('new-password-error');
                    errorEl.textContent = 'New password is required';
                    errorEl.style.display = 'block';
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    const errorEl = document.getElementById('confirm-password-error');
                    errorEl.textContent = 'Passwords do not match';
                    errorEl.style.display = 'block';
                    return;
                }
                
                // Show status message
                passwordSuccessMessage.textContent = 'Processing password change...';
                passwordSuccessMessage.style.display = 'block';
                passwordSuccessMessage.style.backgroundColor = '#e2f3fd';
                passwordSuccessMessage.style.color = '#0c5460';
                
                try {
                    // Get CSRF token from meta tag
                    let csrfToken = '';
                    const metaToken = document.querySelector('meta[name="csrf-token"]');
                    if (metaToken) {
                        csrfToken = metaToken.getAttribute('content');
                    }
                    
                    // Prepare headers
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    
                    if (csrfToken) {
                        headers['X-CSRFToken'] = csrfToken;
                    }
                    
                    // Get user email
                    const userEmail = document.getElementById('display-email').textContent.trim();
                    
                    // Step 1: Request password reset token through forgot-password endpoint
                    passwordSuccessMessage.textContent = 'Requesting password reset...';
                    const forgotApiUrl = window.location.origin + '/api/auth/forgot-password';
                    
                    console.log('Requesting password reset token for email:', userEmail);
                    const forgotResponse = await fetch(forgotApiUrl, {
                        method: 'POST',
                        headers: headers,
                        credentials: 'include',
                        body: JSON.stringify({
                            email: userEmail
                        })
                    });
                    
                    if (!forgotResponse.ok) {
                        console.error('Error requesting password reset:', forgotResponse.status);
                        passwordSuccessMessage.textContent = 'Error: Could not initiate password reset process.';
                        passwordSuccessMessage.style.backgroundColor = '#f8d7da';
                        passwordSuccessMessage.style.color = '#721c24';
                        return;
                    }
                    
                    const forgotData = await forgotResponse.json();
                    console.log('Password reset token response received');
                    
                    if (!forgotData.debug_token) {
                        passwordSuccessMessage.textContent = 'Error: Password reset token not received.';
                        passwordSuccessMessage.style.backgroundColor = '#f8d7da';
                        passwordSuccessMessage.style.color = '#721c24';
                        return;
                    }
                    
                    // Step 2: Use reset token to change password
                    passwordSuccessMessage.textContent = 'Updating password...';
                    const resetApiUrl = window.location.origin + '/api/auth/reset-password';
                    
                    console.log('Using token to reset password...');
                    const resetResponse = await fetch(resetApiUrl, {
                        method: 'POST',
                        headers: headers,
                        credentials: 'include',
                        body: JSON.stringify({
                            token: forgotData.debug_token,
                            new_password: newPassword
                        })
                    });
                    
                    const resetData = await resetResponse.json();
                    
                    if (!resetResponse.ok) {
                        console.error('Error resetting password:', resetResponse.status, resetData);
                        
                        // Handle validation errors
                        if (resetData.error) {
                            if (resetData.error.includes('Password must be')) {
                                const errorEl = document.getElementById('new-password-error');
                                errorEl.textContent = resetData.error;
                                errorEl.style.display = 'block';
                            } else {
                                const errorContainer = document.getElementById('error-container');
                                errorContainer.textContent = resetData.error;
                                errorContainer.style.display = 'block';
                            }
                        } else {
                            passwordSuccessMessage.textContent = 'An error occurred while changing your password.';
                            passwordSuccessMessage.style.backgroundColor = '#f8d7da';
                            passwordSuccessMessage.style.color = '#721c24';
                        }
                        
                        passwordSuccessMessage.style.display = 'block';
                        return;
                    }
                    
                    // Success! Password has been changed in the database
                    console.log('Password successfully changed');
                    passwordSuccessMessage.textContent = 'Password successfully changed!';
                    passwordSuccessMessage.style.backgroundColor = '#d4edda';
                    passwordSuccessMessage.style.color = '#28a745';
                    passwordSuccessMessage.style.display = 'block';
                    
                    // Reset form
                    changePasswordForm.reset();
                    
                } catch (error) {
                    console.error('Error during password change:', error);
                    
                    const errorContainer = document.getElementById('error-container');
                    errorContainer.textContent = 'An error occurred: ' + error.message;
                    errorContainer.style.display = 'block';
                    
                    passwordSuccessMessage.style.display = 'none';
                }
            });
        }
        
        // Deactivate account button
        if (deactivateButton) {
            deactivateButton.addEventListener('click', async function() {
                const confirmed = confirm('Are you sure you want to deactivate your account? This will hide your profile and data.');
                
                if (!confirmed) {
                    return;
                }
                
                try {
                    // Get CSRF token
                    const tokenResponse = await fetch('/dev/get-csrf-token', {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    const tokenData = await tokenResponse.json();
                    const csrfToken = tokenData.csrf_token;
                    
                    // 构建停用账户API URL
                    const apiUrl = window.location.origin + '/api/users/me/deactivate';
                    console.log('Using deactivate account API URL:', apiUrl);
                    
                    // 发送停用请求
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        credentials: 'include'
                    });
                    
                    if (!response.ok) {
                        const data = await response.json();
                        alert('Deactivation error: ' + (data.error || 'Unknown error'));
                        return;
                    }
                    
                    // Success - redirect to logout
                    alert('Your account has been deactivated. You will now be logged out.');
                    window.location.href = '/api/auth/logout';
                    
                } catch (error) {
                    console.error('Deactivation error:', error);
                    alert('An error occurred while deactivating your account. Please try again later.');
                }
            });
        }
        
        // Function to load user profile data
        async function loadUserProfile() {
            try {
                // 构建完整的API URL
                const apiUrl = window.location.origin + '/api/users/me';
                console.log('Loading profile from API URL:', apiUrl);
                
                // 获取用户信息
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                let user;
                
                if (!response.ok) {
                    console.warn('Failed to load profile from API, using Flask template data');
                    // Use data from Flask template as fallback
                    user = {
                        username: "{{ current_user.username }}",
                        email: "{{ current_user.email }}",
                        firstname: "{{ current_user.firstname or '' }}",
                        lastname: "{{ current_user.lastname or '' }}",
                        bio: "{{ current_user.bio or '' }}",
                        avatar: "{{ current_user.avatar or '' }}",
                        dob: "{{ current_user.dob or '' }}",
                        registration_date: "{{ current_user.registration_date or '' }}"
                    };
                } else {
                    // If API is working, use its data
                    user = await response.json();
                }
                
                console.log('User profile loaded:', user);
                
                // Update form fields
                document.getElementById('username').value = user.username || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('firstname').value = user.firstname || '';
                document.getElementById('lastname').value = user.lastname || '';
                document.getElementById('bio').value = user.bio || '';
                document.getElementById('avatar-url').value = user.avatar || '';
                
                if (user.dob) {
                    document.getElementById('dob').value = user.dob;
                }
                
                // Update display elements
                document.getElementById('display-username').textContent = user.username || 'Username';
                document.getElementById('display-email').textContent = user.email || 'Email';
                
                if (user.registration_date) {
                    document.getElementById('display-registration-date').textContent = new Date(user.registration_date).toLocaleDateString();
                } else {
                    document.getElementById('display-registration-date').textContent = 'Unknown';
                }
                
                // Update avatar if available
                if (user.avatar) {
                    document.getElementById('avatar-img').src = user.avatar;
                } else {
                    // Keep the default avatar (inline base64)
                    document.getElementById('avatar-img').src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAIAQMAAAD+wSzIAAAABlBMVEX///+/v7+jQ3Y5AAAADklEQVQI12P4AIX8EAgALgAD/aNpbtEAAAAASUVORK5CYII";
                }
                
                // Hide the loading message
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) {
                    loadingMessage.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error loading profile:', error);
                
                // Use data from Flask template on error
                const user = {
                    username: "{{ current_user.username }}",
                    email: "{{ current_user.email }}",
                    firstname: "{{ current_user.firstname or '' }}",
                    lastname: "{{ current_user.lastname or '' }}",
                    bio: "{{ current_user.bio or '' }}",
                    avatar: "{{ current_user.avatar or '' }}",
                    registration_date: "{{ current_user.registration_date or '' }}"
                };
                
                // Update form fields
                document.getElementById('username').value = user.username || '';
                document.getElementById('email').value = user.email || '';
                document.getElementById('firstname').value = user.firstname || '';
                document.getElementById('lastname').value = user.lastname || '';
                document.getElementById('bio').value = user.bio || '';
                document.getElementById('avatar-url').value = user.avatar || '';
                
                // Update display elements
                document.getElementById('display-username').textContent = user.username || 'Username';
                document.getElementById('display-email').textContent = user.email || 'Email';
                document.getElementById('display-registration-date').textContent = user.registration_date ? 
                    new Date(user.registration_date).toLocaleDateString() : 'Unknown';
                
                // Hide the loading message and show error
                const loadingMessage = document.getElementById('loading-message');
                if (loadingMessage) {
                    loadingMessage.textContent = 'Using locally available profile data';
                    loadingMessage.style.color = '#007bff';
                    
                    // Hide message after 3 seconds
                    setTimeout(() => {
                        loadingMessage.style.display = 'none';
                    }, 3000);
                }
            }
        }
    });
</script>
{% endblock %} 