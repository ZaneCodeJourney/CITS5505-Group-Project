{% extends "base.html" %}

{% block styles %}
<style>
    /* 苹果风格设计 */
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        background-color: #f5f5f7;
        color: #1d1d1f;
        line-height: 1.5;
    }
    
    .container {
        max-width: 800px;
        margin: 40px auto;
        padding: 30px;
        background-color: white;
        border-radius: 18px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    h1 {
        font-weight: 600;
        font-size: 32px;
        margin-bottom: 10px;
        color: #1d1d1f;
    }
    
    p {
        color: #86868b;
        margin-bottom: 30px;
    }
    
    .form-group {
        margin-bottom: 24px;
    }
    
    label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 15px;
        color: #1d1d1f;
    }
    
    input, select, textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d2d2d7;
        border-radius: 12px;
        box-sizing: border-box;
        font-family: inherit;
        font-size: 16px;
        color: #1d1d1f;
        background-color: #ffffff;
        transition: all 0.2s ease;
    }
    
    input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: #0071e3;
        box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.2);
    }
    
    button {
        background-color: #0071e3;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    
    button:hover {
        background-color: #0077ed;
        transform: translateY(-1px);
    }
    
    button:active {
        transform: translateY(0);
    }
    
    .alert {
        padding: 16px;
        margin-bottom: 24px;
        border-radius: 12px;
        font-weight: 500;
    }
    
    .alert-success {
        background-color: #e3f9e5;
        color: #275929;
        border: 1px solid #b0eab5;
    }
    
    .alert-danger {
        background-color: #fdf1f0;
        color: #8a2b24;
        border: 1px solid #f9c9c3;
    }
    
    .alert-info {
        background-color: #e9f3fe;
        color: #1a4971;
        border: 1px solid #c1dffd;
    }
    
    .severity-options {
        display: flex;
        gap: 15px;
    }
    
    .severity-option {
        flex: 1;
        text-align: center;
        padding: 16px;
        border: 1px solid #d2d2d7;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .severity-option h3 {
        font-size: 18px;
        margin-top: 0;
        margin-bottom: 8px;
    }
    
    .severity-option p {
        font-size: 14px;
        margin-bottom: 0;
        color: #86868b;
    }
    
    .severity-option.selected {
        background-color: #f5f5f7;
        border-color: #0071e3;
        box-shadow: 0 0 0 2px rgba(0, 113, 227, 0.2);
    }
    
    .severity-option:hover:not(.selected) {
        background-color: #f5f5f7;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }
    
    .severity-option.low {
        border-left: 4px solid #32d74b;
    }
    
    .severity-option.medium {
        border-left: 4px solid #ff9f0a;
    }
    
    .severity-option.high {
        border-left: 4px solid #ff3b30;
    }
    
    .preview-container {
        margin-top: 16px;
        display: none;
    }
    
    .preview-image {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        border: 1px solid #d2d2d7;
    }
    
    .photo-upload {
        position: relative;
    }
    
    .photo-upload-label {
        display: inline-block;
        padding: 12px 24px;
        background-color: #f5f5f7;
        color: #0071e3;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 500;
        border: 1px solid #d2d2d7;
        transition: all 0.2s ease;
    }
    
    .photo-upload-label:hover {
        background-color: #e8e8ed;
    }
    
    .photo-upload input[type="file"] {
        position: absolute;
        width: 0;
        height: 0;
        opacity: 0;
    }
    
    .loading-indicator {
        display: none;
        margin-left: 8px;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    button.submitting {
        opacity: 0.8;
        cursor: not-allowed;
    }
    
    button.submitting .loading-indicator {
        display: inline-block;
    }
    
    .section-title {
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 20px;
        margin-top: 40px;
        color: #1d1d1f;
    }
    
    .progress-steps {
        display: flex;
        margin-bottom: 40px;
        position: relative;
        justify-content: space-between;
    }
    
    .progress-steps::before {
        content: "";
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        height: 2px;
        background-color: #d2d2d7;
        z-index: 1;
    }
    
    .step {
        text-align: center;
        position: relative;
        z-index: 2;
        background-color: white;
        padding: 0 10px;
    }
    
    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: #f5f5f7;
        border: 2px solid #d2d2d7;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 8px;
        color: #86868b;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .step.active .step-number {
        background-color: #0071e3;
        border-color: #0071e3;
        color: white;
    }
    
    .step.completed .step-number {
        background-color: #32d74b;
        border-color: #32d74b;
        color: white;
    }
    
    .step-label {
        font-size: 14px;
        color: #86868b;
    }
    
    .step.active .step-label {
        color: #1d1d1f;
        font-weight: 500;
    }
    
    /* 整体容器 */
    .container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    }
    
    /* 页面标题 */
    .page-title {
        text-align: center;
        margin-bottom: 20px;
        color: #333;
        font-size: 32px;
        font-weight: 600;
        letter-spacing: -0.5px;
    }
    
    /* 表单组样式 */
    .form-group {
        margin-bottom: 25px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
    }
    
    .form-group input[type="text"],
    .form-group input[type="datetime-local"],
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s;
        background-color: #f9f9f9;
    }
    
    .form-group input[type="text"]:focus,
    .form-group input[type="datetime-local"]:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        background-color: #fff;
    }
    
    /* 自定义潜水地点样式 */
    #custom-site-container {
        background-color: #f5f8ff;
        padding: 15px;
        border-radius: 12px;
        border-left: 4px solid #3b82f6;
        margin-top: 10px;
        animation: fadeIn 0.3s ease-in-out;
    }
    
    .custom-site-inputs {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-gap: 15px;
    }
    
    @media (max-width: 768px) {
        .custom-site-inputs {
            grid-template-columns: 1fr;
        }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div id="alert-container"></div>
    
    <div class="progress-steps">
        <div class="step active">
            <div class="step-number">1</div>
            <div class="step-label">Select Site</div>
        </div>
        <div class="step">
            <div class="step-number">2</div>
            <div class="step-label">Shark Details</div>
        </div>
        <div class="step">
            <div class="step-number">3</div>
            <div class="step-label">Submit Report</div>
        </div>
    </div>
    
    <h1>Report Shark Sighting</h1>
    <p>Use this form to report shark sightings at dive sites to alert other divers about potential safety concerns.</p>
    
    <form id="shark-report-form">
        {% if current_user.is_authenticated %}
        <input type="hidden" id="user-id" value="{{ current_user.id }}">
        {% else %}
        <input type="hidden" id="user-id" value="">
        {% endif %}
        
        <!-- Add CSRF token hidden field -->
        <input type="hidden" name="csrf_token" id="csrf-token" value="{{ csrf_token() }}">
        
        <div class="section-title">Dive Site Information</div>
        
        <div class="form-group">
            <label for="dive-site">Select Dive Site</label>
            <select id="dive-site" required>
                <option value="">-- Select Dive Site --</option>
                <!-- Sites will be loaded here -->
            </select>
        </div>
        
        <div id="custom-site-container" class="form-group" style="display: none;">
            <div class="custom-site-inputs">
                <div class="form-group">
                    <label for="custom-site-name">Custom Dive Site Name</label>
                    <input type="text" id="custom-site-name" placeholder="Enter dive site name">
                </div>
                <div class="form-group">
                    <label for="custom-site-region">Region/Country (Optional)</label>
                    <input type="text" id="custom-site-region" placeholder="e.g., Bali, Indonesia">
                </div>
            </div>
        </div>
        
        <div class="section-title">Shark Information</div>
        
        <div class="form-group">
            <label for="species">Shark Species (if known)</label>
            <input type="text" id="species" placeholder="e.g., Great White Shark, Bull Shark, etc.">
        </div>
        
        <div class="form-group">
            <label for="size-estimate">Estimated Size</label>
            <input type="text" id="size-estimate" placeholder="e.g., 2 meters, 10 feet, etc.">
        </div>
        
        <div class="form-group">
            <label>Risk Level</label>
            <div class="severity-options">
                <div class="severity-option low" data-value="low">
                    <h3>Low</h3>
                    <p>No threat, distant sighting</p>
                </div>
                <div class="severity-option medium selected" data-value="medium">
                    <h3>Medium</h3>
                    <p>Close encounter, potential risk</p>
                </div>
                <div class="severity-option high" data-value="high">
                    <h3>High</h3>
                    <p>Aggressive behavior, direct threat</p>
                </div>
            </div>
            <input type="hidden" id="severity" value="medium">
        </div>
        
        <div class="form-group">
            <label for="sighting-time">Sighting Time</label>
            <input type="datetime-local" id="sighting-time">
        </div>
        
        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" rows="4" placeholder="Describe what you saw, the shark's behavior, and other relevant details"></textarea>
        </div>
        
        <!-- Photo upload feature has been removed because the backend API uses JSON data format, which doesn't support file uploads -->
        
        <button type="submit" id="submit-button">
            Submit Report
            <span class="loading-indicator"></span>
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load dive sites
        loadDiveSites();
        
        // Set up severity options
        setupSeverityOptions();
        
        // Form submission
        document.getElementById('shark-report-form').addEventListener('submit', submitReport);
        
        // Form field change detection for progress steps
        document.getElementById('dive-site').addEventListener('change', updateProgressSteps);
        document.getElementById('species').addEventListener('input', updateProgressSteps);
        document.getElementById('size-estimate').addEventListener('input', updateProgressSteps);
        document.getElementById('description').addEventListener('input', updateProgressSteps);
        
        // Custom dive site input listeners
        document.getElementById('custom-site-name').addEventListener('input', updateProgressSteps);
        document.getElementById('custom-site-region').addEventListener('input', updateProgressSteps);
    });
    
    function updateProgressSteps() {
        const steps = document.querySelectorAll('.step');
        
        // Step 1: Select Site
        const siteSelectValue = document.getElementById('dive-site').value;
        let hasSiteSelection = siteSelectValue !== '';
        
        // If "other" is selected, check if custom site name is filled in
        if (siteSelectValue === 'other') {
            const customSiteName = document.getElementById('custom-site-name').value.trim();
            hasSiteSelection = customSiteName !== '';
        }
        
        if (hasSiteSelection) {
            steps[0].classList.add('completed');
            steps[1].classList.add('active');
        } else {
            steps[0].classList.remove('completed');
            steps[1].classList.remove('active');
        }
        
        // Step 2: Shark Details
        const hasSpecies = document.getElementById('species').value.trim() !== '';
        const hasSize = document.getElementById('size-estimate').value.trim() !== '';
        const hasDescription = document.getElementById('description').value.trim() !== '';
        
        if (hasSpecies && hasSize && hasDescription) {
            steps[1].classList.add('completed');
            steps[2].classList.add('active');
        } else {
            steps[1].classList.remove('completed');
            steps[2].classList.remove('active');
        }
    }
    
    async function loadDiveSites() {
        try {
            const response = await fetch('/api/sites/', {
                method: 'GET',
                headers: {
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                },
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                throw new Error(`Server returned status code: ${response.status}`);
            }
            
            const sites = await response.json();
            console.log("Successfully loaded site data:", sites.length, "sites");
            
            populateDiveSites(sites);
        } catch (error) {
            console.error('Failed to load site data:', error);
            showAlert('Using backup data for dive sites. You can also manually add a new dive site.', 'info');
            
            // Use backup data
            const fallbackSites = [
                { id: 'fb-1', name: 'Great Barrier Reef', region: 'Queensland', country: 'Australia' },
                { id: 'fb-2', name: 'Similan Islands', region: 'Phang Nga', country: 'Thailand' },
                { id: 'fb-3', name: 'Komodo National Park', region: 'East Nusa Tenggara', country: 'Indonesia' },
                { id: 'fb-4', name: 'Blue Hole', region: 'Koror', country: 'Palau' },
                { id: 'fb-5', name: 'North Male Atoll', region: 'Male', country: 'Maldives' },
                { id: 'fb-6', name: 'Saipan Tinian', region: 'Northern Mariana Islands', country: 'USA' },
                { id: 'fb-7', name: 'Paracel Islands', region: 'Hainan', country: 'China' },
                { id: 'fb-8', name: 'Weizhou Island', region: 'Guangxi', country: 'China' },
                { id: 'fb-9', name: 'Mabul Island', region: 'Sabah', country: 'Malaysia' },
                { id: 'fb-10', name: 'Dumaguete', region: 'Negros Oriental', country: 'Philippines' }
            ];
            
            populateDiveSites(fallbackSites);
            
            // Enable custom dive site input
            document.getElementById('custom-site-container').style.display = 'block';
        }
    }
    
    function populateDiveSites(sites) {
        const siteSelect = document.getElementById('dive-site');
        siteSelect.innerHTML = '<option value="">-- Select Dive Site --</option>';
        
        sites.forEach(site => {
            const option = document.createElement('option');
            option.value = site.id;
            option.textContent = site.name + (site.region && site.country ? ` (${site.region}, ${site.country})` : '');
            siteSelect.appendChild(option);
        });
        
        // Add "other" option
        const otherOption = document.createElement('option');
        otherOption.value = "other";
        otherOption.textContent = "-- Other/Custom Dive Site --";
        siteSelect.appendChild(otherOption);
        
        // Listen for selection changes to show/hide custom input
        siteSelect.addEventListener('change', function() {
            if (this.value === 'other') {
                document.getElementById('custom-site-container').style.display = 'block';
            } else {
                document.getElementById('custom-site-container').style.display = 'none';
            }
            updateProgressSteps();
        });
    }
    
    function setupSeverityOptions() {
        const options = document.querySelectorAll('.severity-option');
        const hiddenInput = document.getElementById('severity');
        
        options.forEach(option => {
            option.addEventListener('click', function() {
                // Remove selected class from all options
                options.forEach(opt => opt.classList.remove('selected'));
                
                // Add selected class to clicked option
                this.classList.add('selected');
                
                // Update hidden input value
                hiddenInput.value = this.getAttribute('data-value');
            });
        });
    }
    
    async function submitReport(event) {
        event.preventDefault();
        
        const submitButton = document.getElementById('submit-button');
        
        // Get form data
        let siteId = document.getElementById('dive-site').value;
        const species = document.getElementById('species').value.trim();
        const sizeEstimate = document.getElementById('size-estimate').value.trim();
        const description = document.getElementById('description').value.trim();
        const severity = document.getElementById('severity').value;
        const sightingTime = document.getElementById('sighting-time').value;
        
        // Set user ID, default to 0 if not present
        const userId = document.getElementById('user-id').value || '0';
        
        // Check required fields
        if (!species) {
            showAlert('Please enter shark species', 'danger');
            return;
        }
        
        if (!sizeEstimate) {
            showAlert('Please enter estimated size', 'danger');
            return;
        }
        
        if (!description) {
            showAlert('Please enter a description', 'danger');
            return;
        }
        
        // Process site ID
        // According to backend API, custom site ID must be an integer
        // We'll use a default site ID (1) for custom sites and include custom site info in description
        let customSiteInfo = null;
        if (siteId === 'other') {
            const customSiteName = document.getElementById('custom-site-name').value.trim();
            const customSiteRegion = document.getElementById('custom-site-region').value.trim();
            
            if (!customSiteName) {
                showAlert('Please enter custom dive site name', 'danger');
                return;
            }
            
            // Add custom site info to description
            customSiteInfo = `[Custom site: ${customSiteName}${customSiteRegion ? ', ' + customSiteRegion : ''}] `;
            // Use default site ID 1
            siteId = 1;
        } else if (!siteId) {
            showAlert('Please select a dive site', 'danger');
            return;
        } else {
            // Ensure site ID is an integer
            siteId = parseInt(siteId);
            if (isNaN(siteId)) {
                showAlert('Invalid site ID', 'danger');
                return;
            }
        }
        
        // Set button to submitting state
        submitButton.classList.add('submitting');
        submitButton.disabled = true;
        
        // Show submitting message
        showAlert('Submitting report, please wait...', 'info');
        
        // Get CSRF token for including in JSON data
        const csrfToken = document.getElementById('csrf-token').value || 
                          document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        
        // Prepare JSON data
        const jsonData = {
            user_id: parseInt(userId) || 0,  // Ensure user_id is always an integer, use 0 if parsing fails
            species: species,
            size_estimate: sizeEstimate,
            description: customSiteInfo ? customSiteInfo + description : description,
            severity: severity,
            status: 'active',
            csrf_token: csrfToken // Include CSRF token in JSON data as well
        };
        
        // Add optional fields
        if (sightingTime) {
            jsonData.sighting_time = sightingTime;
        }
        
        try {
            // Try different submission paths
            let response;
            
            try {
                // Get CSRF token - try multiple methods to ensure we have a valid token
                const metaToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                const formToken = document.getElementById('csrf-token').value;
                const csrfToken = formToken || metaToken;
                
                console.log("Using CSRF token:", csrfToken ? "Found token" : "No token found");
                
                response = await fetch(`/api/shark-warnings/site/${siteId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify(jsonData),
                    credentials: 'same-origin'
                });
            } catch (error) {
                console.log("First attempt failed, trying alternative path", error);
                
                // Get CSRF token again in case there was an issue
                const metaToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                const formToken = document.getElementById('csrf-token').value;
                const csrfToken = formToken || metaToken;
                
                response = await fetch(`/shark/site/${siteId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', 
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify(jsonData),
                    credentials: 'same-origin'
                });
            }
            
            // Restore button state
            submitButton.classList.remove('submitting');
            submitButton.disabled = false;
            
            // Check response status
            if (response.ok) {
                console.log("Submission successful, status code:", response.status);
                const result = await response.json();
                console.log("Server response:", result);
                
                // Success - show success message and reset form
                showAlert('Shark sighting report submitted successfully! Thank you for helping keep divers safe.', 'success');
                document.getElementById('shark-report-form').reset();
                document.getElementById('custom-site-container').style.display = 'none';
                
                // Set all steps to completed
                const steps = document.querySelectorAll('.step');
                steps.forEach(step => {
                    step.classList.add('completed');
                    step.classList.remove('active');
                });
                
                // Redirect to shark warning page after 2 seconds
                setTimeout(() => {
                    window.location.href = '/auth/sharkwarning';
                }, 2000);
            } else {
                const errorData = await response.text();
                console.error("Submission failed, status code:", response.status, "error:", errorData);
                
                try {
                    // Try to parse as JSON
                    const jsonError = JSON.parse(errorData);
                    showAlert(`Submission failed: ${jsonError.error || 'Server error'}`, 'danger');
                } catch (e) {
                    // If not JSON, show generic error
                    showAlert(`Submission failed: Server returned error (${response.status})`, 'danger');
                }
            }
        } catch (error) {
            // Restore button state
            submitButton.classList.remove('submitting');
            submitButton.disabled = false;
            
            console.error("Error submitting report:", error);
            showAlert('Error submitting report: ' + error.message, 'danger');
        }
    }
    
    function showAlert(message, type) {
        const alertContainer = document.getElementById('alert-container');
        alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        
        // Scroll to top to show alert
        window.scrollTo(0, 0);
        
        // If success message, automatically remove after 5 seconds
        if (type === 'success') {
            setTimeout(() => {
                const alertElement = alertContainer.firstChild;
                if (alertElement) {
                    alertElement.style.opacity = '0';
                    alertElement.style.transition = 'opacity 0.5s';
                    setTimeout(() => alertContainer.innerHTML = '', 500);
                }
            }, 5000);
        }
    }
</script>
{% endblock %}
