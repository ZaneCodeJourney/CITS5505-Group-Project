/**
 * Dive.site - 潜水日志页面脚本
 * 作者：开发团队
 * 版本：1.0.0
 * 最后更新：2025-04-27
 */

// 当文档加载完成后执行
$(document).ready(function() {
    // 加载导航组件
    $("#nav-placeholder").load("./components/navigation.html", function() {
        // 加载导航后，更新导航状态
        updateNavigation(true);
    });

    // 初始化图表
    initCharts();

    // 加载潜水日志数据
    loadDiveLogs();

    // 设置事件监听器
    setupEventListeners();
});

// 全局变量，用于存储当前的潜水日志和分页信息
let diveLogs = [];
let currentPage = 1;
let totalPages = 1;
let itemsPerPage = 10;

/**
 * 更新导航状态
 * @param {boolean} isLoggedIn - 用户是否已登录
 */
function updateNavigation(isLoggedIn) {
    if (isLoggedIn) {
        // 隐藏登录/注册按钮，显示个人资料按钮
        $('.auth-item').addClass('d-none');
        $('#profile-nav-item').removeClass('d-none');
    } else {
        // 显示登录/注册按钮，隐藏个人资料按钮
        $('.auth-item').removeClass('d-none');
        $('#profile-nav-item').addClass('d-none');

        // 如果未认证，重定向到登录页面
        window.location.href = '/login';
    }
}

/**
 * 初始化图表
 */
function initCharts() {
    // 初始化深度图表
    const depthCtx = document.getElementById('depthChart').getContext('2d');
    window.depthChart = new Chart(depthCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Max Depth (m)',
                data: [],
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    reverse: true,
                    title: {
                        display: true,
                        text: 'Depth (meters)'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Dive Date'
                    }
                }
            }
        }
    });

    // 初始化频率图表
    const freqCtx = document.getElementById('frequencyChart').getContext('2d');
    window.frequencyChart = new Chart(freqCtx, {
        type: 'bar',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            datasets: [{
                label: 'Number of Dives',
                data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                backgroundColor: 'rgba(52, 152, 219, 0.7)',
                borderColor: '#3498db',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Dives'
                    }
                }
            }
        }
    });

    // 初始化地点图表
    const locationCtx = document.getElementById('locationChart').getContext('2d');
    window.locationChart = new Chart(locationCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#3498db', '#2ecc71', '#f39c12', '#e74c3c', '#9b59b6',
                    '#