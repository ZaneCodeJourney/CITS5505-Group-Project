<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Dive.site</title>
    <!-- Include Bootstrap CSS -->
    <!-- 引入Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Include Bootstrap Icons -->
    <!-- 引入Bootstrap图标 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Include Chart.js for data visualization -->
    <!-- 引入Chart.js用于数据可视化 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Include custom CSS -->
    <!-- 引入自定义CSS -->
    <link rel="stylesheet" href="./css/styles.css">
    <!-- Profile page specific styles -->
    <!-- 个人资料页面特定样式 -->
    <style>
        .profile-container {
            margin-top: 30px;
            margin-bottom: 50px;
        }

        .page-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .breadcrumb {
            background: transparent;
            padding: 0;
            margin-bottom: 30px;
        }

        .breadcrumb-item a {
            color: var(--accent-color);
        }

        .breadcrumb-item.active {
            color: var(--light-text);
        }

        .title-wavy {
            position: relative;
            padding-bottom: 15px;
        }

        .title-wavy::after {
            content: "";
            position: absolute;
            left: 0;
            bottom: 0;
            width: 80px;
            height: 3px;
            background-color: var(--accent-color);
            border-radius: 3px;
        }

        .profile-tabs {
            margin-top: 40px;
            border-bottom: 1px solid #eee;
        }

        .profile-tabs .nav-link {
            color: var(--light-text);
            font-weight: 500;
            padding: 10px 20px;
            border: none;
            border-bottom: 3px solid transparent;
        }

        .profile-tabs .nav-link.active {
            color: var(--accent-color);
            background: transparent;
            border-bottom: 3px solid var(--accent-color);
        }

        .tab-content {
            padding: 30px 0;
        }

        .profile-section {
            margin-top: 40px;
        }

        .profile-image-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-image {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #eee;
        }

        .profile-info-box {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .profile-info-label {
            color: var(--light-text);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .profile-info-value {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-color);
        }

        .measurement-toggle {
            display: inline-flex;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .measurement-toggle button {
            padding: 8px 20px;
            border: none;
            background: white;
            color: var(--light-text);
        }

        .measurement-toggle button.active {
            background-color: var(--accent-color);
            color: white;
        }

        .public-profile-btn {
            background-color: #3498db;
            color: white;
            font-weight: 500;
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
        }

        .public-profile-btn:hover {
            background-color: #2980b9;
            color: white;
        }

        .chart-container {
            margin-top: 40px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--primary-color);
        }
    </style>
</head>
<body>
<!-- Include navigation component -->
<!-- 引入导航组件 -->
<div id="nav-placeholder"></div>

<!-- Main content -->
<!-- 主要内容 -->
<div class="container profile-container">
    <!-- Breadcrumb navigation -->
    <!-- 面包屑导航 -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active">Account</li>
        </ol>
    </nav>

    <!-- Page header with title and public profile button -->
    <!-- 带有标题和公开资料按钮的页面头部 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="page-title title-wavy">My Account</h1>
        <a href="\CITS5505\edit-public-profile.html" class="btn public-profile-btn">EDIT MY PUBLIC PROFILE</a>
    </div>

    <!-- Profile tabs navigation -->
    <!-- 个人资料标签导航 -->
    <ul class="nav nav-tabs profile-tabs" id="profileTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="true">MY PUBLIC PROFILE</button>
        </li>

        <li class="nav-item" role="presentation">
            <button class="nav-link" id="password-tab" data-bs-toggle="tab" data-bs-target="#password" type="button" role="tab" aria-controls="password" aria-selected="false">CHANGE PASSWORD</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="email-tab" data-bs-toggle="tab" data-bs-target="#email" type="button" role="tab" aria-controls="email" aria-selected="false">CHANGE EMAIL</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="close-tab" data-bs-toggle="tab" data-bs-target="#close" type="button" role="tab" aria-controls="close" aria-selected="false">CLOSE ACCOUNT</button>
        </li>
    </ul>

    <!-- Tab content -->
    <!-- 标签内容 -->
    <div class="tab-content" id="profileTabsContent">
        <!-- My Profile Tab -->
        <!-- 我的个人资料标签 -->
        <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
            <h2 class="text-center mb-4">My Profile</h2>

            <div class="row">
                <div class="col-md-4">
                    <!-- User profile image -->
                    <!-- 用户头像 -->
                    <div class="profile-image-container">
                        <img src="./images/profile.jpg" alt="User Profile" class="profile-image" id="user-profile-image">
                    </div>
                </div>

                <div class="col-md-8">
                    <!-- User information -->
                    <!-- 用户信息 -->
                    <div class="profile-info-box mb-4">
                        <div class="profile-info-label">NAME</div>
                        <div class="profile-info-value" id="user-name-display">Loading...</div>
                    </div>

                    <div class="profile-info-box mb-4">
                        <div class="profile-info-label">USERNAME</div>
                        <div class="profile-info-value" id="user-username-display">Loading...</div>
                    </div>

                    <div class="profile-info-box mb-4">
                        <div class="profile-info-label">BIO</div>
                        <div class="profile-info-value" id="user-bio-display">No bio yet</div>
                    </div>

                    <div class="profile-info-box mb-4">
                        <div class="profile-info-label">PROFILE VISIBILITY</div>
                        <div class="profile-info-value" id="profile-visibility-display">Public</div>
                    </div>

                    <div class="profile-info-box mb-4">
                        <div class="profile-info-label">EMAIL ADDRESS</div>
                        <div class="profile-info-value" id="user-email">Loading...</div>
                    </div>

                    <div class="profile-info-box">
                        <div class="profile-info-label">SYSTEM OF MEASUREMENT</div>
                        <div class="mt-2">
                            <div class="measurement-toggle">
                                <button class="active" id="metric-btn">Metric</button>
                                <button id="imperial-btn">Imperial</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Visualization Section -->
            <!-- 数据可视化部分 -->
            <div class="row mt-5">
                <div class="col-12">
                    <h3>My Diving Statistics</h3>
                    <p>View your diving activity and statistics over time.</p>
                </div>

                <!-- Dive Depth Chart -->
                <!-- 潜水深度图表 -->
                <div class="col-md-6">
                    <div class="chart-container">
                        <h4 class="chart-title">Dive Depths Over Time</h4>
                        <canvas id="depthChart"></canvas>
                    </div>
                </div>

                <!-- Dive Frequency Chart -->
                <!-- 潜水频率图表 -->
                <div class="col-md-6">
                    <div class="chart-container">
                        <h4 class="chart-title">Dive Frequency by Month (2025)</h4>
                        <canvas id="frequencyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Password Tab -->
        <!-- 更改密码标签 -->
        <div class="tab-pane fade" id="password" role="tabpanel" aria-labelledby="password-tab">
            <h3 class="mb-4">更改密码 (Change Password)</h3>
            <p class="text-muted mb-4">更新您的账户密码，建议定期更换密码以保障账户安全。
                (Update your account password. It's recommended to change your password regularly for security.)</p>

            <!-- 密码更改表单 (Password change form) -->
            <form id="password-change-form" class="needs-validation" novalidate>
                <div class="alert alert-success d-none" id="password-success-alert">
                    密码已成功更新！(Password has been successfully updated!)
                </div>
                <div class="alert alert-danger d-none" id="password-error-alert"></div>

                <div class="mb-3">
                    <label for="current-password" class="form-label">当前密码 (Current Password)*</label>
                    <input type="password" class="form-control" id="current-password" required>
                    <div class="invalid-feedback">
                        请输入当前密码 (Please enter your current password)
                    </div>
                </div>

                <div class="mb-3">
                    <label for="new-password" class="form-label">新密码 (New Password)*</label>
                    <input type="password" class="form-control" id="new-password" required>
                    <div class="invalid-feedback">
                        请输入新密码 (Please enter a new password)
                    </div>
                    <div class="form-text">
                        密码必须至少包含8个字符，包括大写字母、小写字母和数字。
                        (Password must be at least 8 characters long and include uppercase, lowercase letters, and numbers.)
                    </div>
                </div>

                <div class="mb-3">
                    <label for="confirm-password" class="form-label">确认新密码 (Confirm New Password)*</label>
                    <input type="password" class="form-control" id="confirm-password" required>
                    <div class="invalid-feedback">
                        请确认新密码 (Please confirm your new password)
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">
                    更新密码 (Update Password)
                </button>
            </form>
        </div>

        <!-- Email Tab -->
        <!-- 更改邮箱标签 -->
        <div class="tab-pane fade" id="email" role="tabpanel" aria-labelledby="email-tab">
            <h3 class="mb-4">更改邮箱 (Change Email)</h3>
            <p class="text-muted mb-4">更新您的账户电子邮件地址。确保提供一个有效的邮箱，重要的账户通知将会发送到该邮箱。
                (Update your account email address. Make sure to provide a valid email as important account notifications will be sent there.)</p>

            <!-- 邮箱更改表单 (Email change form) -->
            <form id="email-change-form" class="needs-validation" novalidate>
                <div class="alert alert-success d-none" id="email-success-alert">
                    邮箱地址已成功更新！请检查您的新邮箱以完成验证。
                    (Email address has been successfully updated! Please check your new email to complete verification.)
                </div>
                <div class="alert alert-danger d-none" id="email-error-alert"></div>

                <div class="mb-3">
                    <label for="current-email" class="form-label">当前邮箱地址 (Current Email Address)</label>
                    <input type="email" class="form-control" id="current-email" disabled>
                </div>

                <div class="mb-3">
                    <label for="new-email" class="form-label">新邮箱地址 (New Email Address)*</label>
                    <input type="email" class="form-control" id="new-email" required>
                    <div class="invalid-feedback">
                        请输入有效的邮箱地址 (Please enter a valid email address)
                    </div>
                </div>

                <div class="mb-3">
                    <label for="email-password" class="form-label">当前密码 (Current Password)*</label>
                    <input type="password" class="form-control" id="email-password" required>
                    <div class="invalid-feedback">
                        请输入当前密码以确认身份 (Please enter your current password to confirm your identity)
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">
                    更新邮箱 (Update Email)
                </button>
            </form>
        </div>

        <!-- Close Account Tab -->
        <!-- 关闭账户标签 -->
        <div class="tab-pane fade" id="close" role="tabpanel" aria-labelledby="close-tab">
            <h3 class="mb-4 text-danger">关闭账户 (Close Account)</h3>
            <div class="alert alert-warning">
                <strong>警告！(Warning!)</strong> 关闭账户是永久性的，一旦关闭将无法恢复您的个人资料、潜水日志和其他数据。
                (Closing your account is permanent. Once closed, your profile, dive logs, and other data cannot be recovered.)
            </div>

            <p class="text-muted mb-4">
                如果您确定要关闭您的 Dive.site 账户，请在下方输入您的密码，并选择数据处理方式。
                (If you're sure you want to close your Dive.site account, please enter your password below and choose how your data should be handled.)
            </p>

            <!-- 关闭账户表单 (Account closure form) -->
            <form id="close-account-form" class="needs-validation" novalidate>
                <div class="alert alert-success d-none" id="close-success-alert">
                    您的账户已成功关闭。感谢您使用我们的服务。
                    (Your account has been successfully closed. Thank you for using our services.)
                </div>
                <div class="alert alert-danger d-none" id="close-error-alert"></div>

                <div class="mb-4">
                    <label class="form-label">数据处理选项 (Data Handling Options)*</label>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="data_preference" id="anonymize" value="anonymize" required>
                        <label class="form-check-label" for="anonymize">
                            匿名化数据 (Anonymize Data) - 保留您的潜水记录但移除个人信息
                            (Keep your dive records but remove personal information)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="data_preference" id="delete_personal" value="delete_personal" required>
                        <label class="form-check-label" for="delete_personal">
                            删除个人数据 (Delete Personal Data) - 完全删除所有个人数据和潜水记录
                            (Completely remove all personal data and dive records)
                        </label>
                        <div class="invalid-feedback">
                            请选择一个数据处理选项 (Please select a data handling option)
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="close-password" class="form-label">输入密码确认 (Confirm with Password)*</label>
                    <input type="password" class="form-control" id="close-password" required>
                    <div class="invalid-feedback">
                        请输入密码以确认关闭账户 (Please enter your password to confirm account closure)
                    </div>
                </div>

                <div class="mb-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="confirm-close" required>
                        <label class="form-check-label" for="confirm-close">
                            我确认我想要永久关闭我的账户，并了解此操作不可撤销
                            (I confirm that I want to permanently close my account and understand this action cannot be undone)
                        </label>
                        <div class="invalid-feedback">
                            您必须确认此操作 (You must confirm this action)
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-danger">
                    永久关闭账户 (Permanently Close Account)
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Include JavaScript libraries -->
<!-- 引入JavaScript库 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Profile page script -->
<!-- 个人资料页面脚本 -->
<script>
    $(document).ready(function() {
        // Load navigation component
        // 加载导航组件
        $("#nav-placeholder").load("./components/navigation.html", function() {
            // After loading the navigation, update it to show logged-in state
            // 加载导航后，更新它以显示已登录状态
            updateNavigation(true);
        });

        // Check authentication and load user data
        // 检查身份验证并加载用户数据
        checkAuth();

        // Initialize measurement toggle
        // 初始化测量单位切换
        initMeasurementToggle();

        // Initialize charts
        // 初始化图表
        initCharts();
    });

    /**
     * Update navigation based on authentication status
     * 根据身份验证状态更新导航
     * @param {boolean} isLoggedIn - Whether user is logged in
     */
    function updateNavigation(isLoggedIn) {
        if (isLoggedIn) {
            // Hide login/register buttons, show profile button
            $('.auth-item').addClass('d-none');
            $('#profile-nav-item').removeClass('d-none');
        } else {
            // Show login/register buttons, hide profile button
            $('.auth-item').removeClass('d-none');
            $('#profile-nav-item').addClass('d-none');

            // Redirect to login if not authenticated
            window.location.href = '/login';
        }
    }

    /**
     * Check authentication status and load user data
     * 检查身份验证状态并加载用户数据
     */
    function checkAuth() {
        // Get token from storage
        const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');

        if (!token) {
            // Not authenticated
            updateNavigation(false);
            return;
        }

        // Load user data
        fetchUserProfile(token);
    }

    /**
     * Fetch user profile data from API
     * 从API获取用户资料数据
     * @param {string} token - Authentication token
     */
    function fetchUserProfile(token) {
        $.ajax({
            url: '/api/users/me',
            type: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            success: function(response) {
                if ((response.status === 'success' && response.data) || response.id) {
                    // 提取数据，处理不同的API响应格式
                    const userData = response.data || response;

                    // 更新UI显示用户数据
                    updateProfileUI(userData);

                    // 获取潜水统计数据
                    fetchDiveStatistics(token);
                } else {
                    // 处理错误
                    console.error('Failed to fetch profile:', response.error);
                    updateNavigation(false);
                }
            },
            error: function(xhr) {
                // 处理认证错误
                console.error('Authentication error:', xhr.responseText);
                updateNavigation(false);
            }
        });
    }

    /**
     * Update profile UI with user data
     * 使用用户数据更新个人资料UI
     * @param {Object} userData - User profile data
     */
    function updateProfileUI(userData) {
        // 更新用户名称
        $('#user-name-display').text(`${userData.firstname} ${userData.lastname}`);

        // 更新用户名
        $('#user-username-display').text(userData.username);

        // 更新用户邮箱
        $('#user-email').text(userData.email);

        // 更新用户简介
        if (userData.bio) {
            $('#user-bio-display').text(userData.bio);
        } else {
            $('#user-bio-display').text('No bio yet');
        }

        // 更新个人资料可见性
        let visibilityText = 'Public';
        if (userData.profile_visibility === 'friends_only') {
            visibilityText = 'Friends Only';
        } else if (userData.profile_visibility === 'private') {
            visibilityText = 'Private';
        }
        $('#profile-visibility-display').text(visibilityText);

        // 更新头像
        if (userData.avatar) {
            $('#user-profile-image').attr('src', userData.avatar);
        }

        // 根据用户偏好更新测量单位切换
        if (userData.measurement_system === 'imperial') {
            $('#imperial-btn').addClass('active');
            $('#metric-btn').removeClass('active');
        } else {
            $('#metric-btn').addClass('active');
            $('#imperial-btn').removeClass('active');
        }
    }

    /**
     * Initialize measurement toggle buttons
     * 初始化测量单位切换按钮
     */
    function initMeasurementToggle() {
        $('#metric-btn').on('click', function() {
            $(this).addClass('active');
            $('#imperial-btn').removeClass('active');
            updateMeasurementPreference('metric');
        });

        $('#imperial-btn').on('click', function() {
            $(this).addClass('active');
            $('#metric-btn').removeClass('active');
            updateMeasurementPreference('imperial');
        });
    }

    /**
     * Update user's measurement preference
     * 更新用户的测量单位偏好
     * @param {string} system - Measurement system ('metric' or 'imperial')
     */
    function updateMeasurementPreference(system) {
        const token = localStorage.getItem('auth_token') || sessionStorage.getItem('auth_token');

        if (!token) return;

        $.ajax({
            url: '/api/users/me',
            type: 'PUT',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            contentType: 'application/json',
            data: JSON.stringify({
                measurement_system: system
            }),
            success: function(response) {
                if (response.status === 'success') {
                    // Refresh charts with new measurement units
                    fetchDiveStatistics(token);
                } else {
                    alert('Failed to update preference: ' + (response.error?.message || 'Unknown error'));
                }
            },
            error: function(xhr) {
                alert('Failed to update preference. Please try again.');
            }
        });
    }

    /**
     * Fetch dive statistics for charts
     * 获取潜水统计数据用于图表
     * @param {string} token - Authentication token
     */
    function fetchDiveStatistics(token) {
        // Fetch depth-time chart data
        $.ajax({
            url: '/api/users/me/depth-time-chart',
            type: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            success: function(response) {
                if (response.status === 'success') {
                    updateDepthChart(response.data.dives);
                }
            }
        });

        // Fetch frequency chart data
        $.ajax({
            url: '/api/users/me/frequency-chart?period=monthly&year=2025',
            type: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            success: function(response) {
                if (response.status === 'success') {
                    updateFrequencyChart(response.data.frequency);
                }
            }
        });
    }

    // Chart variables
    let depthChart, frequencyChart;

    /**
     * Initialize charts with empty data
     * 用空数据初始化图表
     */
    function initCharts() {
        // Initialize Depth Chart
        const depthCtx = document.getElementById('depthChart').getContext('2d');
        depthChart = new Chart(depthCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Max Depth (m)',
                    data: [],
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        reverse: true,
                        title: {
                            display: true,
                            text: 'Depth (meters)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Dive Date'
                        }
                    }
                }
            }
        });

        // Initialize Frequency Chart
        const freqCtx = document.getElementById('frequencyChart').getContext('2d');
        frequencyChart = new Chart(freqCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Number of Dives',
                    data: [],
                    backgroundColor: 'rgba(52, 152, 219, 0.7)',
                    borderColor: '#3498db',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Dives'
                        }
                    }
                }
            }
        });
    }

    /**
     * Update depth chart with dive data
     * 用潜水数据更新深度图表
     * @param {Array} dives - Array of dive data
     */
    function updateDepthChart(dives) {
        // Extract labels and data
        const labels = dives.map(dive => dive.date);
        const depths = dives.map(dive => dive.max_depth);

        // Update chart data
        depthChart.data.labels = labels;
        depthChart.data.datasets[0].data = depths;

        // Update y-axis label based on measurement system
        const isMetic = $('#metric-btn').hasClass('active');
        depthChart.options.scales.y.title.text = `Depth (${isMetic ? 'meters' : 'feet'})`;

        // Update chart
        depthChart.update();
    }

    /**
     * Update frequency chart with dive frequency data
     * 用潜水频率数据更新频率图表
     * @param {Array} frequency - Array of frequency data
     */
    function updateFrequencyChart(frequency) {
        // Extract labels and data
        const labels = frequency.map(item => item.label);
        const counts